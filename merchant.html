<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #85BB65;
        }

        .merchant-info {
            text-align: right;
        }

        .merchant-info h2 {
            color: #333;
            margin-bottom: 5px;
        }

        .merchant-info p {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            border-bottom: 3px solid #85BB65;
            background: #f8f9fa;
            color: #85BB65;
            font-weight: 600;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            background: #85BB65;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #74a85a;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ff6b6b;
        }

        .btn-danger:hover {
            background: #e55a5a;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .product-image {
            height: 150px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 40px;
            color: #85BB65;
        }

        .product-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .product-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .product-price {
            font-size: 20px;
            font-weight: bold;
            color: #85BB65;
        }

        .product-stock {
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 20px;
            background: #f0f9ff;
            color: #0066cc;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .edit-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .edit-btn:hover {
            background: #bbdefb;
        }

        .delete-btn {
            background: #ffebee;
            color: #d32f2f;
        }

        .delete-btn:hover {
            background: #ffcdd2;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #85BB65;
            box-shadow: 0 0 0 2px rgba(133, 187, 101, 0.2);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ddd;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(133, 187, 101, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            color: #85BB65;
            font-size: 20px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .login-prompt {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 50px;
        }

        .login-prompt h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .login-prompt p {
            color: #666;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-store"></i> Merchant Dashboard
            </div>
            <div class="merchant-info">
                <h2 id="merchantName">Loading...</h2>
                <p id="merchantStore">Store: Loading...</p>
            </div>
        </header>

        <div id="loginPrompt" class="login-prompt" style="display: none;">
            <h2>Merchant Access Required</h2>
            <p>Please log in with your merchant account to access this dashboard.</p>
            <button class="btn" id="goToLoginBtn">
                <i class="fas fa-sign-in-alt"></i> Go to Login
            </button>
        </div>

        <div id="dashboardContent" style="display: none;">
            <div class="tabs">
                <div class="tab active" data-tab="dashboard">Dashboard</div>
                <div class="tab" data-tab="products">Products</div>
                <div class="tab" data-tab="orders">Orders</div>
            </div>

            <!-- Dashboard Tab -->
            <div class="content active" id="dashboard">
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading statistics...
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div class="content" id="products">
                <div class="products-header">
                    <h2>My Products</h2>
                    <button class="btn" id="addProductBtn">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
                
                <div class="products-grid" id="productsGrid">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading products...
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div class="content" id="orders">
                <h2>Recent Orders</h2>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p>No orders yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Product</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label for="name">Product Name</label>
                    <input type="text" id="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="price">Price ($)</label>
                    <input type="number" id="price" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="stockQty">Stock Quantity</label>
                    <input type="number" id="stockQty" class="form-control" min="0" required>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" class="form-control" required>
                        <option value="">Select Category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Home & Garden">Home & Garden</option>
                        <option value="Sports">Sports</option>
                        <option value="Books">Books</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" class="form-control" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="out_of_stock">Out of Stock</option>
                    </select>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn" id="cancelBtn">Cancel</button>
                <button class="btn" id="saveBtn">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
 <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

        <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBKswcE3xGh4feqGZytevh6N-IyrJoJ_7g",
            authDomain: "jeahluy.firebasestorage.app",
            projectId: "jeahluy",
            storageBucket: "jeahluy.firebasestorage.app",
            messagingSenderId: "308746007810",
            appId: "1:308746007810:web:c17396303b14d61c3b3e1b",
            measurementId: "G-3RLD0EB1FT"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentMerchantId = null;
        let currentMerchantData = null;
        let editingProductId = null;
        let products = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("üöÄ Merchant dashboard loading...");
            console.log("Checking auth state...");
            
            // Wait for auth state
            const unsubscribe = auth.onAuthStateChanged(async (user) => {
                unsubscribe(); // Stop listening after first check
                
                if (!user) {
                    console.log("‚ùå No user logged in - showing login prompt");
                    showLoginPrompt();
                    return;
                }
                
                console.log("‚úÖ User logged in:", user.email, user.uid);
                console.log("User UID:", user.uid);
                
                // Try to find merchant data
                await findMerchantData(user);
            });
            
            setupEventListeners();
        });

        // Find merchant data for logged-in user
        async function findMerchantData(user) {
            try {
                console.log("üîç Step 1: Checking users collection for user:", user.uid);
                
                // 1. First check users collection
                const userDoc = await db.collection("users").doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log("üìÑ User document found:", userData);
                    
                    // Check if user has merchantId
                    if (userData.merchantId) {
                        console.log("‚úÖ Found merchantId in user document:", userData.merchantId);
                        await loadMerchantById(userData.merchantId);
                        return;
                    }
                    
                    // Check user role
                    if (userData.role === "merchant") {
                        console.log("‚úÖ User has merchant role");
                        // Try to find merchant by email
                        await searchMerchantByEmail(user.email);
                        return;
                    }
                    
                    console.log("‚ùå User is not a merchant (role:", userData.role, ")");
                    showLoginPrompt("Access denied. Merchant account required.");
                    return;
                }
                
                console.log("üìÑ User document doesn't exist, checking merchant collections...");
                
                // 2. User doesn't exist in users collection, check merchant collections
                await searchMerchantByEmail(user.email);
                
            } catch (error) {
                console.error("‚ùå Error finding merchant data:", error);
                showLoginPrompt("Error: " + error.message);
            }
        }

        // Search for merchant by email in merchant collections
        async function searchMerchantByEmail(email) {
            console.log("üîç Step 2: Searching for merchant with email:", email);
            
            // Check verifiedMerchants collection
            try {
                console.log("üîç Checking verifiedMerchants collection...");
                const merchantQuery = await db.collection("verifiedMerchants")
                    .where("email", "==", email)
                    .limit(1)
                    .get();
                
                if (!merchantQuery.empty) {
                    console.log("‚úÖ Found in verifiedMerchants collection");
                    const merchantDoc = merchantQuery.docs[0];
                    currentMerchantId = merchantDoc.id;
                    currentMerchantData = merchantDoc.data();
                    
                    // Also update user document with merchantId
                    await updateUserWithMerchantId(email, merchantDoc.id);
                    
                    initializeDashboard();
                    return;
                }
                
                console.log("‚ùå Not found in verifiedMerchants");
                
                // Check active_merchants collection
                console.log("üîç Checking active_merchants collection...");
                const activeMerchantQuery = await db.collection("active_merchants")
                    .where("email", "==", email)
                    .limit(1)
                    .get();
                
                if (!activeMerchantQuery.empty) {
                    console.log("‚úÖ Found in active_merchants collection");
                    const merchantDoc = activeMerchantQuery.docs[0];
                    currentMerchantId = merchantDoc.id;
                    currentMerchantData = merchantDoc.data();
                    
                    await updateUserWithMerchantId(email, merchantDoc.id);
                    initializeDashboard();
                    return;
                }
                
                console.log("‚ùå Not found in any merchant collection");
                showLoginPrompt("No merchant account found for email: " + email);
                
            } catch (error) {
                console.error("‚ùå Error searching merchant collections:", error);
                showLoginPrompt("Database error: " + error.message);
            }
        }

        // Load merchant by ID
        async function loadMerchantById(merchantId) {
            console.log("üîç Step 3: Loading merchant by ID:", merchantId);
            
            try {
                // Try verifiedMerchants first
                const merchantDoc = await db.collection("verifiedMerchants").doc(merchantId).get();
                
                if (merchantDoc.exists) {
                    console.log("‚úÖ Found merchant in verifiedMerchants");
                    currentMerchantId = merchantId;
                    currentMerchantData = merchantDoc.data();
                    initializeDashboard();
                    return;
                }
                
                // Try active_merchants
                const activeMerchantDoc = await db.collection("active_merchants").doc(merchantId).get();
                
                if (activeMerchantDoc.exists) {
                    console.log("‚úÖ Found merchant in active_merchants");
                    currentMerchantId = merchantId;
                    currentMerchantData = activeMerchantDoc.data();
                    initializeDashboard();
                    return;
                }
                
                console.log("‚ùå Merchant not found with ID:", merchantId);
                showLoginPrompt("Merchant account not found.");
                
            } catch (error) {
                console.error("‚ùå Error loading merchant:", error);
                showLoginPrompt("Error loading merchant: " + error.message);
            }
        }

        // Update user document with merchantId
        async function updateUserWithMerchantId(email, merchantId) {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                const userDocRef = db.collection("users").doc(user.uid);
                const userDoc = await userDocRef.get();
                
                if (userDoc.exists) {
                    // Update existing user
                    await userDocRef.update({
                        merchantId: merchantId,
                        role: "merchant",
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("‚úÖ Updated user with merchantId");
                } else {
                    // Create new user document
                    const names = email.split('@')[0];
                    await userDocRef.set({
                        firstName: names,
                        lastName: '',
                        email: email,
                        displayName: names,
                        emailVerified: true,
                        role: "merchant",
                        merchantId: merchantId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("‚úÖ Created new user document with merchantId");
                }
            } catch (error) {
                console.warn("‚ö†Ô∏è Could not update user document:", error);
                // Non-critical error, continue anyway
            }
        }

        // Show login prompt
        function showLoginPrompt(message = "Please log in with your merchant account.") {
            console.log("Showing login prompt:", message);
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
            
            // Update message if provided
            if (message && message !== "Please log in with your merchant account.") {
                document.querySelector('#loginPrompt p').textContent = message;
            }
        }

        // Show dashboard content
        function showDashboard() {
            console.log("Showing dashboard");
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }

        // Initialize dashboard
        function initializeDashboard() {
            if (!currentMerchantData) {
                console.log("‚ùå No merchant data available");
                showLoginPrompt();
                return;
            }
            
            console.log("‚úÖ Initializing dashboard with merchant data:", currentMerchantData);
            
            showDashboard();
            
            // Update UI with merchant info
            const merchantName = currentMerchantData.owner || 
                                currentMerchantData.storeName || 
                                currentMerchantData.businessName || 
                                'Merchant';
            const storeName = currentMerchantData.storeName || 
                            currentMerchantData.businessName || 
                            currentMerchantData.store || 
                            'No store name';
            
            document.getElementById('merchantName').textContent = merchantName;
            document.getElementById('merchantStore').textContent = `Store: ${storeName}`;
            
            // Load initial data
            loadProducts();
            loadStatistics();
            
            // Log success
            console.log("üéâ Dashboard initialized successfully!");
            console.log("Merchant ID:", currentMerchantId);
            console.log("Merchant Data:", currentMerchantData);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Go to login button
            document.getElementById('goToLoginBtn').addEventListener('click', function() {
                window.location.href = 'login.html';
            });
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load data if needed
                    if (tabId === 'products') {
                        loadProducts();
                    } else if (tabId === 'dashboard') {
                        loadStatistics();
                    }
                });
            });
            
            // Product modal
            document.getElementById('addProductBtn').addEventListener('click', openAddProductModal);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('saveBtn').addEventListener('click', saveProduct);
        }

        // Load products
        async function loadProducts() {
            if (!currentMerchantId) {
                console.log("‚ùå No merchant ID, cannot load products");
                return;
            }
            
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading products...</div>';
            
            try {
                console.log("üì¶ Loading products for merchant:", currentMerchantId);
                const snapshot = await db.collection("product_list")
                    .where("merchantId", "==", currentMerchantId)
                    .get();
                
                products = [];
                snapshot.forEach(doc => {
                    products.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log("‚úÖ Loaded", products.length, "products");
                renderProducts();
                
            } catch (error) {
                console.error("‚ùå Error loading products:", error);
                productsGrid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading products</p></div>';
            }
        }

        // Render products
        function renderProducts() {
            const productsGrid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No products yet</p>
                        <button class="btn" id="addFirstProduct" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Add Your First Product
                        </button>
                    </div>
                `;
                document.getElementById('addFirstProduct').addEventListener('click', openAddProductModal);
                return;
            }
            
            productsGrid.innerHTML = '';
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <i class="fas fa-${getProductIcon(product.category)}"></i>
                    </div>
                    <div class="product-title">${product.name}</div>
                    <div class="product-desc">${product.description || 'No description'}</div>
                    <div class="product-footer">
                        <div class="product-price">$${parseFloat(product.price || 0).toFixed(2)}</div>
                        <div class="product-stock">Stock: ${product.stockQty || 0}</div>
                    </div>
                    <div class="product-actions">
                        <button class="action-btn edit-btn" data-id="${product.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete-btn" data-id="${product.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    openEditProductModal(productId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    deleteProduct(productId);
                });
            });
        }

        // Get product icon
        function getProductIcon(category) {
            const icons = {
                'Electronics': 'laptop',
                'Clothing': 'tshirt',
                'Home & Garden': 'home',
                'Sports': 'futbol',
                'Books': 'book',
                'Other': 'box'
            };
            return icons[category] || 'box';
        }

        // Load statistics
        async function loadStatistics() {
            if (!currentMerchantId) {
                console.log("‚ùå No merchant ID, cannot load statistics");
                return;
            }
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading statistics...</div>';
            
            try {
                const snapshot = await db.collection("product_list")
                    .where("merchantId", "==", currentMerchantId)
                    .get();
                
                let totalProducts = snapshot.size;
                let totalValue = 0;
                let lowStock = 0;
                let outOfStock = 0;
                
                snapshot.forEach(doc => {
                    const product = doc.data();
                    totalValue += (product.price || 0) * (product.stockQty || 0);
                    
                    if (product.stockQty < 10 && product.stockQty > 0) lowStock++;
                    if (product.stockQty === 0) outOfStock++;
                });
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-value">${totalProducts}</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value">$${totalValue.toFixed(2)}</div>
                        <div class="stat-label">Inventory Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-value">${lowStock}</div>
                        <div class="stat-label">Low Stock</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-value">${outOfStock}</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                `;
                
                console.log("üìä Statistics loaded:", totalProducts, "products");
                
            } catch (error) {
                console.error("‚ùå Error loading statistics:", error);
                statsGrid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading statistics</p></div>';
            }
        }

        // Open add product modal
        function openAddProductModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').classList.add('active');
        }

        // Open edit product modal
        async function openEditProductModal(productId) {
            try {
                const productDoc = await db.collection("product_list").doc(productId).get();
                
                if (!productDoc.exists) {
                    alert('Product not found');
                    return;
                }
                
                const product = productDoc.data();
                editingProductId = productId;
                
                document.getElementById('modalTitle').textContent = 'Edit Product';
                document.getElementById('name').value = product.name || '';
                document.getElementById('description').value = product.description || '';
                document.getElementById('price').value = product.price || '';
                document.getElementById('stockQty').value = product.stockQty || '';
                document.getElementById('category').value = product.category || 'Other';
                document.getElementById('status').value = product.status || 'active';
                
                document.getElementById('productModal').classList.add('active');
                
            } catch (error) {
                console.error("Error loading product:", error);
                alert('Error loading product: ' + error.message);
            }
        }

        // Save product
        async function saveProduct() {
            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const stockQty = parseInt(document.getElementById('stockQty').value);
            const category = document.getElementById('category').value;
            const status = document.getElementById('status').value;
            
            // Validation
            if (!name || isNaN(price) || price < 0 || isNaN(stockQty) || stockQty < 0 || !category) {
                alert('Please fill in all required fields with valid values');
                return;
            }
            
            const productData = {
                name,
                description,
                price,
                stockQty,
                category,
                status,
                merchantId: currentMerchantId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (editingProductId) {
                    // Update
                    await db.collection("product_list").doc(editingProductId).update(productData);
                    alert('Product updated successfully!');
                } else {
                    // Add new
                    productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection("product_list").add(productData);
                    alert('Product added successfully!');
                }
                
                closeModal();
                loadProducts();
                loadStatistics();
                
            } catch (error) {
                console.error("Error saving product:", error);
                alert('Error saving product: ' + error.message);
            }
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            try {
                await db.collection("product_list").doc(productId).delete();
                alert('Product deleted successfully!');
                loadProducts();
                loadStatistics();
            } catch (error) {
                console.error("Error deleting product:", error);
                alert('Error deleting product: ' + error.message);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
        }

        // DEBUG: Force reload if stuck
        setTimeout(() => {
            if (document.getElementById('loginPrompt').style.display === 'none' && 
                document.getElementById('dashboardContent').style.display === 'none') {
                console.log("‚ö†Ô∏è Dashboard stuck, forcing reload");
                window.location.reload();
            }
        }, 5000);
    </script>
</body>
</html>