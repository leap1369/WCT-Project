<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Shopping - Sign In</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1 class="title">Sign In</h1>

    <fieldset>
        <form id="loginForm">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required placeholder="Enter your email"><br>

            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required placeholder="Enter your password"><br>

            <div class="btn-container">
                <button type="button" onclick="window.location.href='homepage.html';">Back</button>
                <button type="button" id="loginBtn">Login</button>
            </div>
        </form>

        <div id="emailNotVerified" style="display: none; text-align: center; color: #ff6b6b; background: #fff5f5; padding: 15px; border-radius: 10px; margin: 10px 0;">
            <p>❌ <strong>Email not verified!</strong></p>
            <p>Please check your email for the verification link.</p>
            <p><button onclick="resendVerification()" style="background: var(--main-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Resend Verification Email</button></p>
        </div>

        <h3>OR</h3>

        <div class="social-signin">
            <img src="asset/google.png" alt="Google Sign-In" class="google-signin" width="61" height="57" onclick="googleLogin()">
            <img src="asset/facebook.png" alt="Facebook Sign-In" class="facebook-signin" width="57" height="53" onclick="alert('Facebook login requires additional setup. Please use Google or Email login.')">
        </div>

        <p><strong><a href="register.html">New member? Click here</a></strong></p>
        <p><strong><a href="forgot.html">Forgot Password?</a></strong></p>
        <p class="language"><strong>Change Language</strong></p>
    </fieldset>

    <!-- Load Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBKswcE3xGh4feqGZytevh6N-IyrJoJ_7g",
            authDomain: "jeahluy.firebaseapp.com",
            projectId: "jeahluy",
            storageBucket: "jeahluy.firebasestorage.app",
            messagingSenderId: "308746007810",
            appId: "1:308746007810:web:c17396303b14d61c3b3e1b",
            measurementId: "G-3RLD0EB1FT"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(app);
        const db = firebase.firestore(app);

        // Email login
        document.getElementById('loginBtn').addEventListener('click', function() {
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value;
            
            if (!email || !password) {
                alert('Please fill email and password');
                return;
            }
            
            // Show loading state
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            
            auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                console.log("✅ User signed in:", user.uid);
                
                // Check if email is verified
                if (!user.emailVerified) {
                    // Show verification message
                    document.getElementById('emailNotVerified').style.display = 'block';
                    document.getElementById('loginForm').style.opacity = '0.5';
                    
                    // Sign out the user
                    return auth.signOut().then(() => {
                        throw new Error('EMAIL_NOT_VERIFIED');
                    });
                }
                
                // Email is verified - update user data in Firestore
                return db.collection("users").doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        // Update last login
                        return db.collection("users").doc(user.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                            emailVerified: true  // Update to true if verified
                        });
                    } else {
                        // Create user document if it doesn't exist
                        const names = user.displayName ? user.displayName.split(' ') : ['User', ''];
                        return db.collection("users").doc(user.uid).set({
                            firstName: names[0],
                            lastName: names[1] || '',
                            email: user.email,
                            displayName: user.displayName || email.split('@')[0],
                            emailVerified: true,
                            role: "user",
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                })
                .then(() => {
                    console.log("✅ Login successful, redirecting...");
                    alert("✅ Login Successful!");
                    window.location.href = "homepage.html";
                });
            })
            .catch((error) => {
                console.error("❌ Login error:", error);
                
                if (error.message === 'EMAIL_NOT_VERIFIED') {
                    // Already handled by showing message
                    return;
                }
                
                let errorMessage = error.message;
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email. Please register first.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Please enter a valid email address.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'This account has been disabled. Please contact support.';
                }
                
                alert(errorMessage);
            })
            .finally(() => {
                // Reset button state
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            });
        });
        
        // Resend verification email
        function resendVerification() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            
            if (!email || !password) {
                alert('Please enter your email and password');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                return userCredential.user.sendEmailVerification();
            })
            .then(() => {
                alert('✅ Verification email resent! Please check your inbox and spam folder.');
                document.getElementById('emailNotVerified').style.display = 'none';
                document.getElementById('loginForm').style.opacity = '1';
                auth.signOut(); // Sign out again
            })
            .catch((error) => {
                alert('❌ Error: ' + error.message);
            });
        }
        
        // Google Login
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
            .then((result) => {
                const user = result.user;
                
                // Get or create user document
                return db.collection("users").doc(user.uid).get()
                .then((doc) => {
                    if (!doc.exists) {
                        // New user - create document
                        const names = user.displayName ? user.displayName.split(' ') : ['User', ''];
                        return db.collection("users").doc(user.uid).set({
                            firstName: names[0],
                            lastName: names[1] || '',
                            email: user.email,
                            displayName: user.displayName,
                            emailVerified: true,
                            role: "user",
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            profilePicture: user.photoURL,
                            provider: "google",
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        // Update last login
                        return db.collection("users").doc(user.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
            })
            .then(() => {
                alert("✅ Google Login Success!");
                window.location.href = "homepage.html";
            })
            .catch(error => {
                console.error("❌ Google login error:", error);
                alert("Google login failed. Please try again.");
            });
        }
    </script>
</body>
</html>