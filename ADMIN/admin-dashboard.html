<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard - Ecommerce Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Styling ===== */
    :root { color-scheme: light; }
    body { font-family: system-ui, Arial, sans-serif; background:#f7f8fb; margin:0; }
    header { max-width: 1200px; margin: 0 auto; padding: 16px; display:flex; align-items:center; justify-content:space-between; background:#fff; border-bottom:1px solid #eee; }
    .pill { background:#eef3ff; border:1px solid #d8e3fe; padding:6px 10px; border-radius:999px; font-size:12px; color:#2c7ef8; }
    nav ul { display:flex; gap:10px; padding:0; list-style:none; margin:0 0 0 12px; }
    nav a { padding:8px 12px; border-radius:8px; text-decoration:none; color:#333; background:#fff; border:1px solid #eee; }
    main { max-width: 1200px; margin: 0 auto; padding: 16px 0 40px; }
    h2 { margin:18px 0 10px; }
    .grid4 { display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; margin:12px 0; }
    .big { font-size:26px; font-weight:700; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:13px; vertical-align:top; }
    thead th { background:#f8f9fc; font-weight:600; }
    .actions button { margin-right:6px; padding:6px 10px; font-size:12px; border:1px solid #ddd; border-radius:6px; cursor:pointer; background:#fff; }
    .btn { display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .btn-primary { background:#2c7ef8; color:#fff; border-color:#2c7ef8; }
    .filters { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
    .search { flex:1; min-width:220px; padding:8px; border:1px solid #ddd; border-radius:8px; }
    .flex { display:flex; align-items:center; gap:8px; }
    .muted { color:#777; font-size:12px; }
    .form-row { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .form-row input, .form-row select, .form-row textarea { padding:8px; border:1px solid #ddd; border-radius:8px; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; }
    .chip.true { background:#e9f9ed; color:#2f9e44; border-color:#b8e4c2; }
    .chip.false { background:#fff4f4; color:#c53b3b; border-color:#f0caca; }
    .id-note { font-size:12px; color:#555; margin-top:6px; }
    .link { color:#2c7ef8; text-decoration:none; }
    .link:hover { text-decoration:underline; }
        /* ===== Sticky Header ===== */
    header {
      position: fixed;  /* Change from default to fixed */
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;    /* Ensure it stays above other content */
      width: 100%;      /* Full width */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Optional shadow */
    }
    
    /* Add padding to main to account for fixed header */
    main {
      margin-top: 80px; /* Adjust based on your header height */
    }
    
    /* Optional: Smooth scrolling for anchor links */
    html {
      scroll-behavior: smooth;
    }
    
    /* Ensure nav links work with fixed header */
    section {
      scroll-margin-top: 80px; /* Same as main margin-top */
    }
        /* Order Status Chips */
    .order-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      text-transform: capitalize;
    }
    
    .status-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .status-processing { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    .status-shipped { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-delivered { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .status-cancelled { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-refunded { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
  </style>
</head>
<body>
  <header>
    <div class="flex">
      <span class="pill">Admin Panel</span>
      <nav>
        <ul>
          <li><a href="#dashboard">Dashboard</a></li>
          <li><a href="#users">Users</a></li>
          <li><a href="#applications">Merchant Applications</a></li>
          <li><a href="#merchants">Active Merchants</a></li>
          <li><a href="#orders">Orders</a></li>
          <li><a href="#products">Products</a></li>
        </ul>
      </nav>
    </div>
    <div class="flex">
      <div id="adminName" class="muted">Admin</div>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </header>

  <main>
    <!-- ===== Overview ===== -->
    <section id="dashboard" class="card">
      <h2>Admin Dashboard</h2>
      <div class="flex"><button id="refreshOverview" class="btn">Refresh Data</button></div>
      <div class="grid4" style="margin-top:12px;">
        <div class="card"><div class="big" id="totalUsers">0</div><div class="muted">Total Users</div></div>
        <div class="card"><div class="big" id="activeMerchants">0</div><div class="muted">Active Merchants</div></div>
        <div class="card"><div class="big" id="totalOrders">0</div><div class="muted">Total Orders</div></div>
        <div class="card"><div class="big" id="platformRevenue">$0</div><div class="muted">Platform Revenue</div></div>
      </div>
    </section>

    <!-- ===== Users ===== -->
    <section id="users" class="card">
      <h2>User Management</h2>
      <div class="filters">
        <select id="userRoleFilter">
          <option value="">All Roles</option>
          <option value="user">user</option>
          <option value="merchant">merchant</option>
          <option value="ADMINISTRATOR">ADMINISTRATOR</option>
        </select>
        <input id="userSearch" class="search" placeholder="Search users (ID, name, email, role)..." />
        <button id="refreshUsers" class="btn">Refresh</button>
      </div>
      

      <div class="form-row">
        <input id="firstName" placeholder="First name" />
        <input id="lastName" placeholder="Last name" />
        <input id="displayName" placeholder="Display name" />
        <input id="email" type="email" placeholder="Email" />
        <input id="profilePicture" placeholder="Profile picture URL (optional)" />
        <select id="role">
          <option value="user">user</option>
          <option value="merchant">merchant</option>
          <option value="ADMINISTRATOR">ADMINISTRATOR</option>
        </select>
        <button id="createUserBtn" class="btn-primary">Create User Doc</button>
      </div>

      <table id="usersTable">
        <thead>
          <tr>
            <th>ID</th><th>User</th><th>Email</th><th>Role</th><th>Email Verified</th><th>Last Login</th><th>Created At</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="id-note">Tip: ID search matches the **document ID** shown in the leftmost column.</div>
    </section>

    <!-- ===== Merchant Applications ===== -->
    <section id="applications" class="card">
      <h2>Merchant Applications</h2>
      <div class="filters">
        <select id="appStatusFilter">
          <option value="">All Status</option>
          <option value="Pending Review">Pending Review</option>
          <option value="Under Review">Under Review</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
        </select>
        <input id="appSearch" class="search" placeholder="Search applications (ID, business, type, city, email)..." />
        <button id="refreshApps" class="btn">Refresh</button>
      </div>

      <!-- Optional admin-side quick create -->
      <div class="form-row">
        <input id="appBusinessName" placeholder="Business Name" />
        <select id="appBusinessType">
          <option value="Retail">Retail</option><option value="Wholesale">Wholesale</option>
          <option value="Manufacturing">Manufacturing</option><option value="Service">Service</option>
          <option value="Technology">Technology</option><option value="Agriculture">Agriculture</option>
          <option value="Construction">Construction</option><option value="Hospitality">Hospitality</option>
          <option value="Transportation">Transportation</option><option value="Finance">Finance</option>
          <option value="Healthcare">Healthcare</option><option value="Education">Education</option>
          <option value="Real Estate">Real Estate</option><option value="Entertainment">Entertainment</option>
          <option value="Nonprofit">Nonprofit</option>
        </select>
        <input id="appAddress" placeholder="Address" />
        <select id="appCity">
          <option value="Phnom Penh">Phnom Penh</option><option value="Siem Reap">Siem Reap</option>
        </select>
        <input id="appZipcode" placeholder="Zipcode" />
        <input id="appDescription" placeholder="Business Description" />
        <input id="appApplicantEmail" placeholder="Applicant Email (optional)" />
        <button id="createAppBtn" class="btn-primary">Save Application</button>
      </div>

      <table id="merchantAppsTable">
        <thead>
          <tr>
            <th>Application ID</th><th>Business Name</th><th>Type</th><th>City</th>
            <th>Applicant Email</th><th>Business Doc</th><th>Identity Doc</th>
            <th>Applied Date</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="id-note">Note: Application IDs match the **user's doc ID** (set by the registration form).</div>
    </section>
    <!-- ===== Verified (Active) Merchants ===== -->
    <section id="merchants" class="card">
      <h2>Active Merchants</h2>
      <div class="filters">
        <input id="merchantSearch" class="search" placeholder="Search merchants (ID, store, owner, city, email)..." />
        <button id="refreshMerchants" class="btn">Refresh</button>
      </div>
     
      <div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1999;"></div>
      
      <table id="merchantsTable">
        <thead>
          <tr><th>ID</th><th>Store</th><th>Owner</th><th>City</th><th>Email</th><th>Docs</th><th>Joined</th><th>Status</th><th>Verification</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
      
         <!-- ===== Orders ===== -->
    <section id="orders" class="card">
      <h2>Order Management</h2>
      
      <div class="filters">
        <select id="orderStatusFilter">
          <option value="">All Status</option>
          <option value="pending">Pending</option>
          <option value="processing">Processing</option>
          <option value="shipped">Shipped</option>
          <option value="delivered">Delivered</option>
          <option value="cancelled">Cancelled</option>
          <option value="refunded">Refunded</option>
        </select>
        <input id="orderSearch" class="search" placeholder="Search orders (ID, customer, email, product)..." />
        <button id="refreshOrders" class="btn">Refresh</button>
        <button id="createTestOrderBtn" class="btn" style="background:#28a745; color:white;">Create Test Order</button>
      </div>

      <!-- Add this Create Test Order Modal -->
      <div id="createTestOrderModal" class="card" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2000; background:white; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0;">Create Test Order</h3>
        
        <div style="margin-bottom:20px;">
          <h4>Customer Information</h4>
          <div class="form-row">
            <input id="testCustomerName" placeholder="Customer Name" value="Test Customer" style="flex:1;" />
            <input id="testCustomerEmail" placeholder="Email" value="test@example.com" style="flex:1;" />
            <input id="testCustomerPhone" placeholder="Phone" value="123-456-7890" style="flex:1;" />
          </div>
        </div>
        
        <div style="margin-bottom:20px;">
          <h4>Shipping Information</h4>
          <div class="form-row">
            <input id="testShippingAddress" placeholder="Address" value="123 Test Street" style="flex:1;" />
            <input id="testShippingCity" placeholder="City" value="Phnom Penh" style="flex:1;" />
            <input id="testShippingZip" placeholder="Zip Code" value="12000" style="flex:1;" />
          </div>
        </div>
        
        <div style="margin-bottom:20px;">
          <h4>Order Items (Add up to 5 items)</h4>
          <div id="testOrderItems">
            <!-- Items will be added here dynamically -->
          </div>
          <button id="addTestItemBtn" class="btn" style="margin-top:10px;">+ Add Item</button>
        </div>
        
        <div style="margin-bottom:20px;">
          <h4>Order Details</h4>
          <div class="form-row">
            <select id="testOrderStatus" style="flex:1;">
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <select id="testPaymentStatus" style="flex:1;">
              <option value="pending">Payment Pending</option>
              <option value="paid" selected>Paid</option>
              <option value="refunded">Refunded</option>
              <option value="failed">Failed</option>
            </select>
            <select id="testPaymentMethod" style="flex:1;">
              <option value="credit_card">Credit Card</option>
              <option value="paypal">PayPal</option>
              <option value="cash_on_delivery">Cash on Delivery</option>
              <option value="bank_transfer">Bank Transfer</option>
            </select>
          </div>
        </div>
        
        <div style="margin-bottom:20px;">
          <h4>Order Summary</h4>
          <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
              <span>Subtotal:</span>
              <span>$<span id="testSubtotal">0.00</span></span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
              <span>Shipping:</span>
              <span>$<input id="testShippingCost" type="number" step="0.01" min="0" value="5.99" style="width:80px; padding:4px;" /></span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
              <span>Tax:</span>
              <span>$<input id="testTax" type="number" step="0.01" min="0" value="2.99" style="width:80px; padding:4px;" /></span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:bold; padding-top:8px; border-top:1px solid #dee2e6;">
              <span>Total:</span>
              <span>$<span id="testTotal">0.00</span></span>
            </div>
          </div>
        </div>
        
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="cancelTestOrderBtn" class="btn">Cancel</button>
          <button id="saveTestOrderBtn" class="btn" style="background:#28a745; color:white;">Create Order</button>
        </div>
      </div>
      <div id="createTestOrderModalOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1999;"></div>
      
      <!-- Rest of your existing order modal and table remain here -->

      <!-- Order Details Modal -->
      <div id="orderModal" class="card" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2000; background:white; padding:24px; max-width:800px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0;">Order Details <span id="modalOrderId" class="muted"></span></h3>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
          <div>
            <h4>Customer Information</h4>
            <div><strong>Name:</strong> <span id="modalCustomerName">-</span></div>
            <div><strong>Email:</strong> <span id="modalCustomerEmail">-</span></div>
            <div><strong>Phone:</strong> <span id="modalCustomerPhone">-</span></div>
          </div>
          
          <div>
            <h4>Shipping Information</h4>
            <div><strong>Address:</strong> <span id="modalShippingAddress">-</span></div>
            <div><strong>City:</strong> <span id="modalShippingCity">-</span></div>
            <div><strong>Zip:</strong> <span id="modalShippingZip">-</span></div>
          </div>
        </div>
        
        <h4>Order Items</h4>
        <table style="width:100%; margin-bottom:20px;">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="modalOrderItems"></tbody>
        </table>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
          <div>
            <h4>Order Summary</h4>
            <div><strong>Subtotal:</strong> $<span id="modalSubtotal">0.00</span></div>
            <div><strong>Shipping:</strong> $<span id="modalShippingCost">0.00</span></div>
            <div><strong>Tax:</strong> $<span id="modalTax">0.00</span></div>
            <div><strong>Total:</strong> $<span id="modalTotal">0.00</span></div>
          </div>
          
          <div>
            <h4>Order Status</h4>
            <div><strong>Current Status:</strong> <span id="modalCurrentStatus" class="chip"></span></div>
            <div><strong>Payment Status:</strong> <span id="modalPaymentStatus">-</span></div>
            <div><strong>Order Date:</strong> <span id="modalOrderDate">-</span></div>
          </div>
        </div>
        
        <div style="margin-bottom:20px;">
          <h4>Update Status</h4>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" data-status-action="pending">Set Pending</button>
            <button class="btn" data-status-action="processing">Set Processing</button>
            <button class="btn" data-status-action="shipped">Set Shipped</button>
            <button class="btn" data-status-action="delivered">Set Delivered</button>
            <button class="btn" style="background:#dc3545; color:white;" data-status-action="cancelled">Cancel Order</button>
            <button class="btn" style="background:#ffc107; color:black;" data-status-action="refunded">Refund</button>
          </div>
        </div>
        
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="closeOrderModal" class="btn">Close</button>
        </div>
      </div>
      <div id="orderModalOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1999;"></div>

      <table id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ===== Product Management ===== -->
    <section id="products" class="card">
      <h2>Product Management</h2>
      <div class="filters">
        <select id="productCategoryFilter">
          <option value="">Select Category</option>
          <option value="Electronics">Electronics & Gadgets</option>
          <option value="Clothing">Clothing & Fashion</option>
          <option value="Footwear">Footwear & Shoes</option>
          <option value="Home & Garden">Home & Garden</option>
          <option value="Kitchen">Kitchen & Dining</option>
          <option value="Furniture">Furniture & Decor</option>
          <option value="Sports">Sports & Outdoors</option>
          <option value="Books">Books & Stationery</option>
          <option value="Health">Health & Beauty</option>
          <option value="Toys">Toys & Games</option>
          <option value="Automotive">Automotive Parts</option>
          <option value="Jewelry">Jewelry & Accessories</option>
          <option value="Food">Food & Beverages</option>
          <option value="Pet">Pet Supplies</option>
          <option value="Office">Office Supplies</option>
          <option value="Tools">Tools & Hardware</option>
          <option value="Baby">Baby & Kids</option>
          <option value="Art">Art & Crafts</option>
          <option value="Musical">Musical Instruments</option>
          <option value="Other">Other</option>
        </select>
        <select id="productStatusFilter">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="out_of_stock">Out of Stock</option>
        </select>
        <input id="productSearch" class="search" placeholder="Search products (name, description, merchant ID)..." />
        <button id="refreshProducts" class="btn">Refresh</button>
      </div>

      <!-- Create/Edit Product Form -->
      <div class="form-row">
        <input id="productName" placeholder="Product Name" />
        <input id="productDescription" placeholder="Description" />
        <input id="productPrice" type="number" placeholder="Price" step="0.01" min="0" />
        <input id="productStockQty" type="number" placeholder="Stock Quantity" min="0" />
        <select id="productCategory">
          <option value="">Select Category</option>
          <option value="Electronics">Electronics & Gadgets</option>
          <option value="Clothing">Clothing & Fashion</option>
          <option value="Footwear">Footwear & Shoes</option>
          <option value="Home & Garden">Home & Garden</option>
          <option value="Kitchen">Kitchen & Dining</option>
          <option value="Furniture">Furniture & Decor</option>
          <option value="Sports">Sports & Outdoors</option>
          <option value="Books">Books & Stationery</option>
          <option value="Health">Health & Beauty</option>
          <option value="Toys">Toys & Games</option>
          <option value="Automotive">Automotive Parts</option>
          <option value="Jewelry">Jewelry & Accessories</option>
          <option value="Food">Food & Beverages</option>
          <option value="Pet">Pet Supplies</option>
          <option value="Office">Office Supplies</option>
          <option value="Tools">Tools & Hardware</option>
          <option value="Baby">Baby & Kids</option>
          <option value="Art">Art & Crafts</option>
          <option value="Musical">Musical Instruments</option>
          <option value="Other">Other</option>
        </select>
        <select id="productStatus">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="out_of_stock">Out of Stock</option>
        </select>
        <input id="productMerchantId" placeholder="Merchant ID (optional)" />
        <button id="createProductBtn" class="btn-primary">Create Product</button>
        <button id="updateProductBtn" class="btn" style="display:none;">Update Product</button>
        <button id="cancelEditBtn" class="btn" style="display:none;">Cancel</button>
      </div>

      <table id="productsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Category</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Status</th>
            <th>Merchant ID</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>
   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs,
      updateDoc, deleteDoc, query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBKswcE3xGh4feqGZytevh6N-IyrJoJ_7g",
      authDomain: "jeahluy.firebaseapp.com",
      projectId: "jeahluy",
      storageBucket: "jeahluy.firebasestorage.app",
      messagingSenderId: "308746007810",
      appId: "1:308746007810:web:c17396303b14d61c3b3e1b",
      measurementId: "G-3RLD0EB1FT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_UID = "zYSujcmGisVdCNPYCfwb7tbpG3D2";
    const ROLES = { USER: "user", MERCHANT: "merchant", ADMIN: "ADMINISTRATOR" };
    
    // Utility Functions
    const normalizeRole = (val) => { 
      if (!val) return ""; 
      const s = String(val).trim().toLowerCase(); 
      if (s === "user") return ROLES.USER; 
      if (s === "merchant") return ROLES.MERCHANT; 
      if (s.startsWith("admin")) return ROLES.ADMIN; 
      return ROLES.USER; 
    };
    
    const fmtDate = (v, withTime = false) => { 
      if (!v) return "-"; 
      const d = v?.toDate ? v.toDate() : (typeof v === "string" ? new Date(v) : new Date(v)); 
      return withTime ? d.toLocaleString() : d.toLocaleDateString(); 
    };
    
    const debounce = (fn, ms = 250) => { 
      let t; 
      return (...args) => { 
        clearTimeout(t); 
        t = setTimeout(() => fn(...args), ms); 
      }; 
    };

    let bootstrapped = false;

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.uid !== ADMIN_UID) {
        if (!/admin-login\.html$/i.test(location.pathname)) location.replace("admin-login.html");
        return;
      }
      if (bootstrapped) return;
      bootstrapped = true;

      document.getElementById("adminName").textContent = `Admin (${user.email || ADMIN_UID})`;

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        try { await signOut(auth); } catch(_) {}
        location.replace("admin-login.html");
      });

      // Overview
      document.getElementById("refreshOverview").addEventListener("click", initOverview);

      // Users
      const onUserSearch = debounce(loadUsers, 200);
      document.getElementById("userRoleFilter").addEventListener("change", loadUsers);
      document.getElementById("userSearch").addEventListener("input", onUserSearch);
      document.getElementById("refreshUsers").addEventListener("click", loadUsers);
      document.getElementById("createUserBtn").addEventListener("click", createUserDoc);

      // Applications
      const onAppSearch = debounce(loadMerchantApplications, 200);
      document.getElementById("appStatusFilter").addEventListener("change", loadMerchantApplications);
      document.getElementById("appSearch").addEventListener("input", onAppSearch);
      document.getElementById("refreshApps").addEventListener("click", loadMerchantApplications);
      document.getElementById("createAppBtn").addEventListener("click", createApplicationFromAdmin);

      // Verified merchants
      const onMerchantSearch = debounce(loadVerifiedMerchants, 200);
      document.getElementById("merchantSearch").addEventListener("input", onMerchantSearch);
      document.getElementById("refreshMerchants").addEventListener("click", loadVerifiedMerchants);
            // Orders
      const onOrderSearch = debounce(loadOrders, 200);
      document.getElementById("orderStatusFilter").addEventListener("change", loadOrders);
      document.getElementById("orderSearch").addEventListener("input", onOrderSearch);
      document.getElementById("refreshOrders").addEventListener("click", loadOrders);
      
      // Order modal events
      document.getElementById("closeOrderModal").addEventListener("click", hideOrderModal);
      document.getElementById("orderModalOverlay").addEventListener("click", hideOrderModal);
      
      // Status update buttons
      document.querySelectorAll('[data-status-action]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const status = e.target.getAttribute('data-status-action');
          updateOrderStatus(status);
        });
      });

      // Product Management
      const onProductSearch = debounce(loadProducts, 200);
      document.getElementById("productSearch").addEventListener("input", onProductSearch);
      document.getElementById("refreshProducts").addEventListener("click", loadProducts);
      document.getElementById("productCategoryFilter").addEventListener("change", loadProducts);
      document.getElementById("productStatusFilter").addEventListener("change", loadProducts);
      document.getElementById("createProductBtn").addEventListener("click", createProduct);
      document.getElementById("updateProductBtn").addEventListener("click", updateProduct);
      document.getElementById("cancelEditBtn").addEventListener("click", cancelEdit);

            // Test order functionality
      document.getElementById("createTestOrderBtn")?.addEventListener("click", showCreateTestOrderModal);
      document.getElementById("cancelTestOrderBtn")?.addEventListener("click", hideCreateTestOrderModal);
      document.getElementById("saveTestOrderBtn")?.addEventListener("click", createTestOrder);
      document.getElementById("addTestItemBtn")?.addEventListener("click", addTestItem);
      document.getElementById("createTestOrderModalOverlay")?.addEventListener("click", hideCreateTestOrderModal);
      
      // Add input listeners for shipping and tax
      document.getElementById("testShippingCost")?.addEventListener("input", calculateTestOrderTotal);
      document.getElementById("testTax")?.addEventListener("input", calculateTestOrderTotal);

      // Initial load
      initOverview();
      loadUsers();
      loadMerchantApplications();
      loadVerifiedMerchants();
      loadProducts();
    });

    /* ===== Overview ===== */
    async function initOverview() {
      const users = await getDocs(collection(db, "users"));
      const verified = await getDocs(collection(db, "verifiedMerchants"));
      document.getElementById("totalUsers").textContent = users.size;
      document.getElementById("activeMerchants").textContent = verified.size;
      document.getElementById("totalOrders").textContent = 0;
      document.getElementById("platformRevenue").textContent = "$0.00";
    }

    /* ===== Users ===== */
    async function createUserDoc() {
      const firstName = document.getElementById("firstName").value.trim();
      const lastName = document.getElementById("lastName").value.trim();
      const displayName = document.getElementById("displayName").value.trim();
      const email = document.getElementById("email").value.trim();
      const profilePicture = document.getElementById("profilePicture").value.trim();
      const role = normalizeRole(document.getElementById("role").value);
      if (!email || (!firstName && !displayName)) return alert("Provide Email and First/Display name.");
      await addDoc(collection(db, "users"), {
        createdAt: new Date(),
        displayName: displayName || `${firstName || ""} ${lastName || ""}`.trim(),
        email, emailVerified: false,
        firstName: firstName || "", lastName: lastName || "",
        lastLogin: null, profilePicture: profilePicture || "", role
      });
      ["firstName","lastName","displayName","email","profilePicture"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("role").value = ROLES.USER;
      await loadUsers(); await initOverview();
    }

    async function loadUsers() {
      const tbody = document.querySelector("#usersTable tbody"); tbody.innerHTML = "";
      const roleFilter = normalizeRole(document.getElementById("userRoleFilter").value || "");
      const qText = (document.getElementById("userSearch").value || "").toLowerCase();
      const base = collection(db, "users");

      let q;
      if (roleFilter) { q = query(base, where("role", "==", roleFilter)); }
      else { try { q = query(base, orderBy("createdAt","desc")); } catch { q = base; } }

      let snap; try { snap = await getDocs(q); }
      catch { snap = roleFilter ? await getDocs(query(base, where("role","==", roleFilter))) : await getDocs(base); }

      const matches = snap.docs.map(d => ({ id: d.id, data: d.data() }))
        .filter(({id, data:u}) => {
          if (!qText) return true;
          const hay = [id, u.displayName, u.firstName, u.lastName, u.email, u.role]
            .map(x => String(x || "").toLowerCase()).join(" ");
          return hay.includes(qText);
        })
        .sort((a,b) => {
          const aj = a.data.createdAt ? (a.data.createdAt?.toDate ? a.data.createdAt.toDate() : new Date(a.data.createdAt)) : 0;
          const bj = b.data.createdAt ? (b.data.createdAt?.toDate ? b.data.createdAt.toDate() : new Date(b.data.createdAt)) : 0;
          return bj - aj;
        });

      if (!matches.length) { const tr = document.createElement("tr"); tr.innerHTML = `<td colspan="8" class="muted">No users found.</td>`; tbody.appendChild(tr); return; }

      matches.forEach(({ id, data: d }) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td><div>${d.displayName || `${d.firstName || "-"} ${d.lastName || ""}`.trim()}</div></td>
          <td>${d.email || "-"}</td>
          <td>${d.role || "-"}</td>
          <td><span class="chip ${d.emailVerified ? "true" : "false"}">${d.emailVerified ? "true" : "false"}</span></td>
          <td>${fmtDate(d.lastLogin, true)}</td>
          <td>${fmtDate(d.createdAt, true)}</td>
          <td class="actions">
            <button data-action="set-role" data-id="${id}" data-role="user">Role: user</button>
            <button data-action="set-role" data-id="${id}" data-role="merchant">Role: merchant</button>
            <button data-action="set-role" data-id="${id}" data-role="ADMINISTRATOR">Role: ADMIN</button>
            <button data-action="verify-email" data-id="${id}">Verify email</button>
            <button data-action="delete" data-id="${id}">Delete</button>
            
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.onclick = async (e) => {
        const btn = e.target.closest("button[data-action]"); if (!btn) return;
        const id = btn.dataset.id; const action = btn.dataset.action;
        try {
          if (action === "set-role") { await updateDoc(doc(db, "users", id), { role: normalizeRole(btn.dataset.role) }); }
          else if (action === "verify-email") { await updateDoc(doc(db, "users", id), { emailVerified: true }); }
          else if (action === "delete") { await deleteDoc(doc(db, "users", id)); }
          await loadUsers(); await initOverview();
        } catch (err) { alert(err?.message || "Action failed"); }
      };
    }

    /* ===== Merchant Applications ===== */
    async function createApplicationFromAdmin() {
      const businessName = document.getElementById("appBusinessName").value.trim();
      const businessType = document.getElementById("appBusinessType").value;
      const address = document.getElementById("appAddress").value.trim();
      const city = document.getElementById("appCity").value;
      const zipcode = document.getElementById("appZipcode").value.trim();
      const description = document.getElementById("appDescription").value.trim();
      const applicantEmail = (document.getElementById("appApplicantEmail").value || "").trim();
      if (!businessName || !businessType || !city) return alert("Business Name, Type, City required.");

      let applicantUserId = null;
      if (applicantEmail) {
        const q = query(collection(db, "users"), where("email","==", applicantEmail));
        const s = await getDocs(q);
        if (!s.empty) applicantUserId = s.docs[0].id;
      }

      if (applicantUserId) {
        await setDoc(doc(db, "merchantApplications", applicantUserId), {
          applicantUserId, applicantEmail,
          businessName, businessType, address, city, zipcode, description,
          status: "Pending Review", createdAt: new Date()
        }, { merge:true });
      } else {
        await addDoc(collection(db, "merchantApplications"), {
          applicantUserId: null, applicantEmail,
          businessName, businessType, address, city, zipcode, description,
          status: "Pending Review", createdAt: new Date()
        });
      }

      ["appBusinessName","appAddress","appZipcode","appDescription","appApplicantEmail"].forEach(id => document.getElementById(id).value = "");
      await loadMerchantApplications();
    }

    async function loadMerchantApplications() {
      const status = document.getElementById("appStatusFilter").value;
      const term = (document.getElementById("appSearch").value || "").toLowerCase();
      const base = collection(db, "merchantApplications");

      let q = status ? query(base, where("status","==",status)) : base;
      try { q = query(q, orderBy("createdAt","desc"), limit(200)); } catch(_) {}

      let snap; try { snap = await getDocs(q); }
      catch { snap = status ? await getDocs(query(base, where("status","==",status))) : await getDocs(base); }

      const tbody = document.querySelector("#merchantAppsTable tbody");
      tbody.innerHTML = "";

      const matches = snap.docs.map(d => ({ id: d.id, data: d.data() }))
        .filter(({id, data:a}) => {
          if (!term) return true;
          const hay = [id, a.businessName, a.businessType, a.city, a.applicantEmail]
            .map(x => String(x || "").toLowerCase()).join(" ");
          return hay.includes(term);
        });

      if (!matches.length) { const tr = document.createElement("tr"); tr.innerHTML = `<td colspan="10" class="muted">No applications.</td>`; tbody.appendChild(tr); return; }

      matches.forEach(({ id, data: d }) => {
        const businessLink = d.businessDocUrl
          ? `<a class="link" href="${d.businessDocUrl}" target="_blank" rel="noopener">Open</a>` : "-";
        const identityLink = d.identityDocUrl
          ? `<a class="link" href="${d.identityDocUrl}" target="_blank" rel="noopener">Open</a>` : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td>${d.businessName || "-"}</td>
          <td>${d.businessType || "-"}</td>
          <td>${d.city || "-"}</td>
          <td>${d.applicantEmail || "-"}</td>
          <td>${businessLink}</td>
          <td>${identityLink}</td>
          <td>${fmtDate(d.createdAt, true)}</td>
          <td>${d.status}</td>
          <td class="actions">
            <button data-action="approve" data-id="${id}">Approve</button>
            <button data-action="reject" data-id="${id}">Reject</button>
            <button data-action="delete" data-id="${id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.onclick = async (e) => {
        const btn = e.target.closest("button[data-action]"); if (!btn) return;
        const id = btn.dataset.id; const action = btn.dataset.action;
        try {
          const appRef = doc(db, "merchantApplications", id);
          if (action === "approve") {
            const app = (await getDoc(appRef)).data();
            await setDoc(doc(db, "verifiedMerchants", id), {
              store: app.businessName,
              owner: app.owner || app.businessName,
              city: app.city,
              email: app.applicantEmail || "",
              businessDocUrl: app.businessDocUrl || null,
              identityDocUrl: app.identityDocUrl || null,
              status: "Active",
              verification: "Verified",
              joined: new Date(),
              applicationId: id,
              businessType: app.businessType,
              address: app.address || "",
              zipcode: app.zipcode || "",
              description: app.description || ""
            }, { merge:true });
            await deleteDoc(appRef);
          } else if (action === "reject") {
            await updateDoc(appRef, { status: "Rejected", rejectedAt: new Date() });
          } else if (action === "delete") {
            await deleteDoc(appRef);
          }
          await loadMerchantApplications(); await loadVerifiedMerchants(); await initOverview();
        } catch (err) { alert(err?.message || "Action failed"); }
      };
    }

    /* ===== Active Merchants ===== */
    async function loadVerifiedMerchants() {
      const tbody = document.querySelector("#merchantsTable tbody");
      const term = (document.getElementById("merchantSearch").value || "").toLowerCase();
      tbody.innerHTML = "";

      let q; try { q = query(collection(db, "verifiedMerchants"), orderBy("joined","desc")); }
      catch { q = collection(db, "verifiedMerchants"); }

      let snap; try { snap = await getDocs(q); }
      catch { snap = await getDocs(collection(db, "verifiedMerchants")); }

      const matches = snap.docs.map(d => ({ id: d.id, data: d.data() }))
        .filter(({id, data:m}) => {
          if (!term) return true;
          const hay = [id, m.store, m.owner, m.city, m.email]
            .map(x => String(x || "").toLowerCase()).join(" ");
          return hay.includes(term);
        });

      if (!matches.length) { const tr = document.createElement("tr"); tr.innerHTML = `<td colspan="10" class="muted">No verified merchants.</td>`; tbody.appendChild(tr); return; }

      matches.forEach(({ id, data: d }) => {
        const docsHTML = [
          d.businessDocUrl ? `<a class="link" href="${d.businessDocUrl}" target="_blank" rel="noopener">BizDoc</a>` : null,
          d.identityDocUrl ? `<a class="link" href="${d.identityDocUrl}" target="_blank" rel="noopener">IDDoc</a>` : null
        ].filter(Boolean).join(" | ") || "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td>${d.store || "-"}</td>
          <td>${d.owner || "-"}</td>
          <td>${d.city || "-"}</td>
          <td>${d.email || "-"}</td>
          <td>${docsHTML}</td>
          <td>${fmtDate(d.joined)}</td>
          <td>${d.status || "Active"}</td>
          <td>${d.verification || "Verified"}</td>
          <td class="actions">
            <button data-action="activate" data-id="${id}">Activate</button>
            <button data-action="suspend" data-id="${id}">Suspend</button>
            <button data-action="delete" data-id="${id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.onclick = async (e) => {
        const btn = e.target.closest("button[data-action]"); if (!btn) return;
        const id = btn.dataset.id; const action = btn.dataset.action;
        try {
          const ref = doc(db, "verifiedMerchants", id);
          if (action === "activate") { await updateDoc(ref, { status: "Active" }); }
          else if (action === "suspend") { await updateDoc(ref, { status: "Suspended" }); }
          else if (action === "delete") { await deleteDoc(ref); }
          await loadVerifiedMerchants(); await initOverview();
        } catch (err) { alert(err?.message || "Action failed"); }
      };
    }
        /* ===== Order Management ===== */
    let currentOrderId = null;
    
    // Show order details modal
    function showOrderModal(orderId) {
      currentOrderId = orderId;
      document.getElementById("modalOrderId").textContent = `#${orderId.substring(0, 8)}...`;
      
      // Show modal
      document.getElementById("orderModal").style.display = "block";
      document.getElementById("orderModalOverlay").style.display = "block";
      
      // Load order details
      loadOrderDetails(orderId);
    }
    
    // Hide order modal
    function hideOrderModal() {
      document.getElementById("orderModal").style.display = "none";
      document.getElementById("orderModalOverlay").style.display = "none";
      currentOrderId = null;
    }
    
    // Load order details
    async function loadOrderDetails(orderId) {
      try {
        const orderRef = doc(db, "order_history", orderId);
        const orderSnap = await getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert("Order not found!");
          hideOrderModal();
          return;
        }
        
        const order = orderSnap.data();
        
        // Fill customer info
        document.getElementById("modalCustomerName").textContent = order.customerName || "-";
        document.getElementById("modalCustomerEmail").textContent = order.customerEmail || "-";
        document.getElementById("modalCustomerPhone").textContent = order.customerPhone || "-";
        
        // Fill shipping info
        document.getElementById("modalShippingAddress").textContent = order.shippingAddress || "-";
        document.getElementById("modalShippingCity").textContent = order.shippingCity || "-";
        document.getElementById("modalShippingZip").textContent = order.shippingZip || "-";
        
        // Fill order items
        const itemsTbody = document.getElementById("modalOrderItems");
        itemsTbody.innerHTML = "";
        
        let subtotal = 0;
        const items = order.items || [];
        
        items.forEach(item => {
          const row = document.createElement("tr");
          const itemSubtotal = (item.price || 0) * (item.quantity || 1);
          subtotal += itemSubtotal;
          
          row.innerHTML = `
            <td>${item.name || "Unknown Product"}</td>
            <td>${item.quantity || 1}</td>
            <td>$${(item.price || 0).toFixed(2)}</td>
            <td>$${itemSubtotal.toFixed(2)}</td>
          `;
          itemsTbody.appendChild(row);
        });
        
        // Calculate totals
        const shipping = order.shippingCost || 0;
        const tax = order.tax || 0;
        const total = subtotal + shipping + tax;
        
        document.getElementById("modalSubtotal").textContent = subtotal.toFixed(2);
        document.getElementById("modalShippingCost").textContent = shipping.toFixed(2);
        document.getElementById("modalTax").textContent = tax.toFixed(2);
        document.getElementById("modalTotal").textContent = total.toFixed(2);
        
        // Fill order status
        const status = order.status || "pending";
        const statusElem = document.getElementById("modalCurrentStatus");
        statusElem.textContent = status;
        statusElem.className = `chip status-${status}`;
        
        document.getElementById("modalPaymentStatus").textContent = order.paymentStatus || "pending";
        document.getElementById("modalOrderDate").textContent = fmtDate(order.orderDate, true);
        
      } catch (err) {
        console.error("Error loading order details:", err);
        alert("Error loading order details: " + err.message);
      }
    }
    
    // Update order status
    async function updateOrderStatus(newStatus) {
      if (!currentOrderId) return;
      
      try {
        const orderRef = doc(db, "order_history", currentOrderId);
        const updateData = {
          status: newStatus,
          updatedAt: new Date()
        };
        
        // Add status-specific updates
        if (newStatus === "cancelled") {
          updateData.cancelledAt = new Date();
        } else if (newStatus === "refunded") {
          updateData.refundedAt = new Date();
          updateData.paymentStatus = "refunded";
        } else if (newStatus === "delivered") {
          updateData.deliveredAt = new Date();
        } else if (newStatus === "shipped") {
          updateData.shippedAt = new Date();
          updateData.trackingNumber = updateData.trackingNumber || `TRK${Date.now().toString().slice(-8)}`;
        }
        
        await updateDoc(orderRef, updateData);
        
        // Reload order details and orders list
        await loadOrderDetails(currentOrderId);
        await loadOrders();
        
        alert(`Order status updated to ${newStatus}`);
        
      } catch (err) {
        console.error("Error updating order status:", err);
        alert("Error updating order status: " + err.message);
      }
    }
    
    // Load all orders
    async function loadOrders() {
      const tbody = document.querySelector("#ordersTable tbody");
      if (!tbody) return;
      
      tbody.innerHTML = "";
      
      const statusFilter = document.getElementById("orderStatusFilter")?.value || "";
      const searchTerm = (document.getElementById("orderSearch")?.value || "").toLowerCase();
      
      try {
        let q = collection(db, "order_history");
        
        // Apply status filter if selected
        if (statusFilter) {
          q = query(q, where("status", "==", statusFilter));
        }
        
        // Try to order by date
        try {
          q = query(q, orderBy("orderDate", "desc"));
        } catch (err) {
          console.log("No index for orderDate ordering");
        }
        
        const snap = await getDocs(q);
        
        if (snap.empty) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="8" class="muted">No orders found.</td>`;
          tbody.appendChild(tr);
          return;
        }
        
        // Filter and process orders
        const orders = snap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        })).filter(order => {
          // Apply search filter
          if (!searchTerm) return true;
          
          const searchable = [
            order.id,
            order.customerName || "",
            order.customerEmail || "",
            order.orderId || "",
            order.status || ""
          ].map(x => String(x).toLowerCase()).join(" ");
          
          // Also search in items
          const itemNames = (order.items || []).map(item => item.name || "").join(" ");
          
          return searchable.includes(searchTerm) || itemNames.toLowerCase().includes(searchTerm);
        });
        
        // Sort by date (newest first)
        orders.sort((a, b) => {
          const dateA = a.orderDate?.toDate ? a.orderDate.toDate() : new Date(a.orderDate || 0);
          const dateB = b.orderDate?.toDate ? b.orderDate.toDate() : new Date(b.orderDate || 0);
          return dateB - dateA;
        });
        
        // Display orders
        orders.forEach(order => {
          // Calculate total
          const items = order.items || [];
          const subtotal = items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
          const shipping = order.shippingCost || 0;
          const tax = order.tax || 0;
          const total = subtotal + shipping + tax;
          
          // Count items
          const itemCount = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
          
          // Create status badge
          const status = order.status || "pending";
          const statusBadge = `<span class="order-status status-${status}">${status}</span>`;
          
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${order.id.substring(0, 12)}...</td>
            <td>
              <div><strong>${order.customerName || "Unknown Customer"}</strong></div>
              <div class="muted">${order.customerEmail || "-"}</div>
            </td>
            <td>${itemCount} item${itemCount !== 1 ? 's' : ''}</td>
            <td>$${total.toFixed(2)}</td>
            <td>${statusBadge}</td>
            <td>${order.paymentStatus || "pending"}</td>
            <td>${fmtDate(order.orderDate, true)}</td>
            <td class="actions">
              <button data-action="view-order" data-id="${order.id}">View</button>
              <button data-action="edit-order" data-id="${order.id}">Edit</button>
              <button data-action="delete-order" data-id="${order.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        // Add event listeners to order actions
        tbody.onclick = async (e) => {
          const btn = e.target.closest("button[data-action]");
          if (!btn) return;
          
          const orderId = btn.dataset.id;
          const action = btn.dataset.action;
          
          try {
            if (action === "view-order") {
              showOrderModal(orderId);
            } else if (action === "edit-order") {
              // You can expand this to show an edit form
              alert("Edit functionality coming soon!");
            } else if (action === "delete-order") {
              if (confirm("Are you sure you want to delete this order? This action cannot be undone.")) {
                await deleteDoc(doc(db, "order_history", orderId));
                await loadOrders();
                alert("Order deleted successfully!");
              }
            }
          } catch (err) {
            alert(err?.message || "Action failed");
          }
        };
        
      } catch (err) {
        console.error("Error loading orders:", err);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="8" class="muted">Error loading orders: ${err.message}</td>`;
        tbody.appendChild(tr);
      }
    }
    
    // Create sample order (for testing)
    async function createSampleOrder() {
      const sampleOrder = {
        customerName: "John Doe",
        customerEmail: "john@example.com",
        customerPhone: "123-456-7890",
        shippingAddress: "123 Main St",
        shippingCity: "Phnom Penh",
        shippingZip: "12000",
        items: [
          { name: "Sample Product 1", price: 29.99, quantity: 2 },
          { name: "Sample Product 2", price: 49.99, quantity: 1 }
        ],
        subtotal: 109.97,
        shippingCost: 5.99,
        tax: 10.99,
        total: 126.95,
        status: "pending",
        paymentStatus: "paid",
        paymentMethod: "credit_card",
        orderDate: new Date(),
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      try {
        await addDoc(collection(db, "order_history"), sampleOrder);
        await loadOrders();
        alert("Sample order created!");
      } catch (err) {
        alert("Error creating sample order: " + err.message);
      }
    }
        /* ===== Create Test Order Functions ===== */
    let testOrderItems = [];
    
    // Show create test order modal
    function showCreateTestOrderModal() {
      // Reset form
      testOrderItems = [
        { name: "Sample Product 1", price: 29.99, quantity: 1 },
        { name: "Sample Product 2", price: 49.99, quantity: 2 }
      ];
      
      renderTestOrderItems();
      calculateTestOrderTotal();
      
      // Show modal
      document.getElementById("createTestOrderModal").style.display = "block";
      document.getElementById("createTestOrderModalOverlay").style.display = "block";
    }
    
    // Hide create test order modal
    function hideCreateTestOrderModal() {
      document.getElementById("createTestOrderModal").style.display = "none";
      document.getElementById("createTestOrderModalOverlay").style.display = "none";
      testOrderItems = [];
    }
    
    // Render test order items
    function renderTestOrderItems() {
      const container = document.getElementById("testOrderItems");
      container.innerHTML = "";
      
      testOrderItems.forEach((item, index) => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "form-row";
        itemDiv.style.marginBottom = "8px";
        itemDiv.innerHTML = `
          <input type="text" placeholder="Product Name" value="${item.name}" 
                 data-index="${index}" data-field="name" style="flex:2;" />
          <input type="number" step="0.01" min="0" placeholder="Price" value="${item.price}" 
                 data-index="${index}" data-field="price" style="flex:1;" />
          <input type="number" min="1" placeholder="Qty" value="${item.quantity}" 
                 data-index="${index}" data-field="quantity" style="width:80px;" />
          <button type="button" class="btn" data-index="${index}" 
                  style="background:#dc3545; color:white; width:40px;"></button>
        `;
        container.appendChild(itemDiv);
      });
      
      // Add event listeners for input changes
      container.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', (e) => {
          const index = parseInt(e.target.dataset.index);
          const field = e.target.dataset.field;
          const value = e.target.value;
          
          if (field === 'price' || field === 'quantity') {
            testOrderItems[index][field] = parseFloat(value) || 0;
          } else {
            testOrderItems[index][field] = value;
          }
          
          calculateTestOrderTotal();
        });
      });
      
      // Add event listeners for delete buttons
      container.querySelectorAll('button[data-index]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          testOrderItems.splice(index, 1);
          renderTestOrderItems();
          calculateTestOrderTotal();
        });
      });
    }
    
    // Calculate test order total
    function calculateTestOrderTotal() {
      let subtotal = 0;
      
      testOrderItems.forEach(item => {
        subtotal += (item.price || 0) * (item.quantity || 1);
      });
      
      const shipping = parseFloat(document.getElementById("testShippingCost").value) || 0;
      const tax = parseFloat(document.getElementById("testTax").value) || 0;
      const total = subtotal + shipping + tax;
      
      document.getElementById("testSubtotal").textContent = subtotal.toFixed(2);
      document.getElementById("testTotal").textContent = total.toFixed(2);
    }
    
    // Add new test item
    function addTestItem() {
      if (testOrderItems.length >= 5) {
        alert("Maximum 5 items per order");
        return;
      }
      
      testOrderItems.push({
        name: "New Product",
        price: 19.99,
        quantity: 1
      });
      
      renderTestOrderItems();
      calculateTestOrderTotal();
    }
    
    // Create test order in database
    async function createTestOrder() {
      // Get customer info
      const customerName = document.getElementById("testCustomerName").value.trim();
      const customerEmail = document.getElementById("testCustomerEmail").value.trim();
      const customerPhone = document.getElementById("testCustomerPhone").value.trim();
      
      // Get shipping info
      const shippingAddress = document.getElementById("testShippingAddress").value.trim();
      const shippingCity = document.getElementById("testShippingCity").value.trim();
      const shippingZip = document.getElementById("testShippingZip").value.trim();
      
      // Get order details
      const status = document.getElementById("testOrderStatus").value;
      const paymentStatus = document.getElementById("testPaymentStatus").value;
      const paymentMethod = document.getElementById("testPaymentMethod").value;
      
      // Calculate totals
      let subtotal = 0;
      testOrderItems.forEach(item => {
        subtotal += (item.price || 0) * (item.quantity || 1);
      });
      
      const shippingCost = parseFloat(document.getElementById("testShippingCost").value) || 0;
      const tax = parseFloat(document.getElementById("testTax").value) || 0;
      const total = subtotal + shippingCost + tax;
      
      // Validate
      if (!customerName || !customerEmail) {
        alert("Please enter customer name and email");
        return;
      }
      
      if (testOrderItems.length === 0) {
        alert("Please add at least one item to the order");
        return;
      }
      
      // Generate order ID
      const orderId = `TEST-${Date.now().toString().slice(-8)}`;
      
      // Create order object
      const orderData = {
        orderId: orderId,
        customerName: customerName,
        customerEmail: customerEmail,
        customerPhone: customerPhone,
        shippingAddress: shippingAddress,
        shippingCity: shippingCity,
        shippingZip: shippingZip,
        items: testOrderItems.map(item => ({
          name: item.name,
          price: parseFloat(item.price.toFixed(2)),
          quantity: parseInt(item.quantity)
        })),
        subtotal: parseFloat(subtotal.toFixed(2)),
        shippingCost: parseFloat(shippingCost.toFixed(2)),
        tax: parseFloat(tax.toFixed(2)),
        total: parseFloat(total.toFixed(2)),
        status: status,
        paymentStatus: paymentStatus,
        paymentMethod: paymentMethod,
        orderDate: new Date(),
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      try {
        // Save to Firestore
        await addDoc(collection(db, "order_history"), orderData);
        
        // Success
        alert(` Test order created successfully!\nOrder ID: ${orderId}\nTotal: $${total.toFixed(2)}`);
        
        // Close modal and refresh orders
        hideCreateTestOrderModal();
        await loadOrders();
        
      } catch (err) {
        console.error("Error creating test order:", err);
        alert(" Error creating test order: " + err.message);
      }
    }
    
    // Create quick test orders (for testing without modal)
    async function createQuickTestOrder() {
      const testCustomers = [
        "John Smith", "Emma Johnson", "Michael Brown", "Sarah Davis", "David Wilson",
        "Lisa Miller", "James Taylor", "Jessica Anderson", "Robert Thomas", "Jennifer Jackson"
      ];
      
      const testProducts = [
        { name: "Smartphone X", price: 699.99 },
        { name: "Laptop Pro", price: 1299.99 },
        { name: "Wireless Earbuds", price: 89.99 },
        { name: "Smart Watch", price: 249.99 },
        { name: "Tablet Mini", price: 399.99 },
        { name: "Gaming Console", price: 499.99 },
        { name: "Bluetooth Speaker", price: 79.99 },
        { name: "Digital Camera", price: 599.99 },
        { name: "Headphones Pro", price: 199.99 },
        { name: "Fitness Tracker", price: 129.99 }
      ];
      
      const statuses = ["pending", "processing", "shipped", "delivered"];
      const paymentMethods = ["credit_card", "paypal", "cash_on_delivery"];
      
      // Generate random order
      const customer = testCustomers[Math.floor(Math.random() * testCustomers.length)];
      const itemCount = Math.floor(Math.random() * 3) + 1; // 1-3 items
      const items = [];
      
      for (let i = 0; i < itemCount; i++) {
        const product = testProducts[Math.floor(Math.random() * testProducts.length)];
        items.push({
          name: product.name,
          price: product.price,
          quantity: Math.floor(Math.random() * 2) + 1 // 1-2 quantity
        });
      }
      
      // Calculate totals
      let subtotal = 0;
      items.forEach(item => {
        subtotal += item.price * item.quantity;
      });
      
      const shippingCost = Math.random() > 0.5 ? 9.99 : 0; // 50% chance of free shipping
      const tax = subtotal * 0.08; // 8% tax
      const total = subtotal + shippingCost + tax;
      
      const orderData = {
        customerName: customer,
        customerEmail: `${customer.toLowerCase().replace(/\s+/g, '.')}@example.com`,
        customerPhone: `+1${Math.floor(Math.random() * 9000000000) + 1000000000}`,
        shippingAddress: `${Math.floor(Math.random() * 999) + 1} ${["Main", "Oak", "Pine", "Maple", "Cedar"][Math.floor(Math.random() * 5)]} St`,
        shippingCity: ["Phnom Penh", "Siem Reap", "Battambang", "Sihanoukville"][Math.floor(Math.random() * 4)],
        shippingZip: ["12000", "17252", "02000", "18000"][Math.floor(Math.random() * 4)],
        items: items,
        subtotal: parseFloat(subtotal.toFixed(2)),
        shippingCost: parseFloat(shippingCost.toFixed(2)),
        tax: parseFloat(tax.toFixed(2)),
        total: parseFloat(total.toFixed(2)),
        status: statuses[Math.floor(Math.random() * statuses.length)],
        paymentStatus: Math.random() > 0.2 ? "paid" : "pending", // 80% paid, 20% pending
        paymentMethod: paymentMethods[Math.floor(Math.random() * paymentMethods.length)],
        orderDate: new Date(Date.now() - Math.floor(Math.random() * 30) * 24 * 60 * 60 * 1000), // Random date in last 30 days
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      try {
        await addDoc(collection(db, "order_history"), orderData);
        return { success: true, orderId: orderData.orderId };
      } catch (err) {
        console.error("Error creating quick test order:", err);
        return { success: false, error: err.message };
      }
    }
    
    // Create multiple test orders
    async function createMultipleTestOrders(count = 5) {
      const createBtn = document.getElementById("createTestOrderBtn");
      const originalText = createBtn.textContent;
      
      createBtn.disabled = true;
      createBtn.textContent = `Creating ${count} orders...`;
      
      let successCount = 0;
      let errorCount = 0;
      
      for (let i = 0; i < count; i++) {
        const result = await createQuickTestOrder();
        if (result.success) {
          successCount++;
        } else {
          errorCount++;
        }
        
        // Small delay between creations
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      createBtn.disabled = false;
      createBtn.textContent = originalText;
      
      await loadOrders();
      
      alert(` Created ${successCount} test orders successfully!\n${errorCount > 0 ? `Failed: ${errorCount} orders` : ''}`);
    }

    /* ===== Product Management ===== */
    let editingProductId = null;

    async function loadProducts() {
  const tbody = document.querySelector("#productsTable tbody");
  if (!tbody) return;
  
  tbody.innerHTML = "";
  
  const category = document.getElementById("productCategoryFilter")?.value || "";
  const status = document.getElementById("productStatusFilter")?.value || "";
  const searchTerm = (document.getElementById("productSearch")?.value || "").toLowerCase();
  
  try {
    // Get ALL products without any where() clauses
    const q = collection(db, "product_list");
    const snap = await getDocs(q);
    
    if (snap.empty) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" class="muted">No products found.</td>`;
      tbody.appendChild(tr);
      return;
    }
    
    // Convert to array and apply ALL filters in memory
    let products = snap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    // Filter by category (if selected)
    if (category) {
      products = products.filter(product => product.category === category);
    }
    
    // Filter by status (if selected)
    if (status) {
      products = products.filter(product => product.status === status);
    }
    
    // Filter by search term (if entered)
    if (searchTerm) {
      products = products.filter(product => {
        const searchable = [
          product.id,
          product.name || "",
          product.description || "",
          product.merchantId || "",
          product.category || ""
        ].map(x => String(x).toLowerCase()).join(" ");
        
        return searchable.includes(searchTerm);
      });
    }
    
    // Sort by createdAt (newest first) in memory
    products.sort((a, b) => {
      const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
      const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
      return dateB - dateA;
    });
    
    if (!products.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" class="muted">No products match your filters.</td>`;
      tbody.appendChild(tr);
      return;
    }
    
    // Display results
    products.forEach(product => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${product.id}</td>
        <td>${product.name || "-"}</td>
        <td>${product.category || "-"}</td>
        <td>$${parseFloat(product.price || 0).toFixed(2)}</td>
        <td>${product.stockQty || 0}</td>
        <td><span class="chip ${product.status === 'active' ? 'true' : 'false'}">${product.status || "-"}</span></td>
        <td><span class="muted">${(product.merchantId || "").substring(0, 8)}...</span></td>
        <td>${fmtDate(product.createdAt, true)}</td>
        <td>${fmtDate(product.updatedAt, true)}</td>
        <td class="actions">
          <button data-action="edit" data-id="${product.id}">Edit</button>
          <button data-action="toggle-status" data-id="${product.id}">${product.status === 'active' ? 'Deactivate' : 'Activate'}</button>
          <button data-action="delete" data-id="${product.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    
    tbody.onclick = async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      
      try {
        if (action === "edit") {
          await editProduct(id);
        } else if (action === "toggle-status") {
          await toggleProductStatus(id);
        } else if (action === "delete") {
          if (confirm("Are you sure you want to delete this product?")) {
            await deleteDoc(doc(db, "product_list", id));
            await loadProducts();
          }
        }
      } catch (err) {
        alert(err?.message || "Action failed");
      }
    };
    
  } catch (err) {
    console.error("Error loading products:", err);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="10" class="muted">Error loading products: ${err.message}</td>`;
    tbody.appendChild(tr);
  }
}

    async function createProduct() {
      const name = document.getElementById("productName").value.trim();
      const description = document.getElementById("productDescription").value.trim();
      const price = parseFloat(document.getElementById("productPrice").value);
      const stockQty = parseInt(document.getElementById("productStockQty").value);
      const category = document.getElementById("productCategory").value;
      const status = document.getElementById("productStatus").value;
      const merchantId = document.getElementById("productMerchantId").value.trim();
      
      if (!name || !category || price < 0 || stockQty < 0) {
        return alert("Please fill in all required fields with valid values.");
      }
      
      if (merchantId) {
        try {
          const merchantDoc = await getDoc(doc(db, "verifiedMerchants", merchantId));
          if (!merchantDoc.exists()) {
            if (!confirm("Merchant ID not found in verified merchants. Continue anyway?")) {
              return;
            }
          }
        } catch (err) {
          console.log("Merchant verification skipped");
        }
      }
      
      const productData = {
        name,
        description,
        price: parseFloat(price.toFixed(2)),
        stockQty,
        category,
        status,
        merchantId: merchantId || null,
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      try {
        await addDoc(collection(db, "product_list"), productData);
        
        document.getElementById("productName").value = "";
        document.getElementById("productDescription").value = "";
        document.getElementById("productPrice").value = "";
        document.getElementById("productStockQty").value = "";
        document.getElementById("productMerchantId").value = "";
        
        await loadProducts();
      } catch (err) {
        alert("Error creating product: " + err.message);
      }
    }

    async function editProduct(productId) {
      try {
        const productDoc = await getDoc(doc(db, "product_list", productId));
        
        if (!productDoc.exists()) {
          alert("Product not found!");
          return;
        }
        
        const product = productDoc.data();
        
        document.getElementById("productName").value = product.name || "";
        document.getElementById("productDescription").value = product.description || "";
        document.getElementById("productPrice").value = product.price || "";
        document.getElementById("productStockQty").value = product.stockQty || "";
        document.getElementById("productCategory").value = product.category || "Other";
        document.getElementById("productStatus").value = product.status || "active";
        document.getElementById("productMerchantId").value = product.merchantId || "";
        
        editingProductId = productId;
        document.getElementById("createProductBtn").style.display = "none";
        document.getElementById("updateProductBtn").style.display = "inline-block";
        document.getElementById("cancelEditBtn").style.display = "inline-block";
        
      } catch (err) {
        alert("Error loading product for editing: " + err.message);
      }
    }

    async function updateProduct() {
      if (!editingProductId) return;
      
      const name = document.getElementById("productName").value.trim();
      const description = document.getElementById("productDescription").value.trim();
      const price = parseFloat(document.getElementById("productPrice").value);
      const stockQty = parseInt(document.getElementById("productStockQty").value);
      const category = document.getElementById("productCategory").value;
      const status = document.getElementById("productStatus").value;
      const merchantId = document.getElementById("productMerchantId").value.trim();
      
      if (!name || !category || price < 0 || stockQty < 0) {
        return alert("Please fill in all required fields with valid values.");
      }
      
      const productData = {
        name,
        description,
        price: parseFloat(price.toFixed(2)),
        stockQty,
        category,
        status,
        merchantId: merchantId || null,
        updatedAt: new Date()
      };
      
      try {
        await updateDoc(doc(db, "product_list", editingProductId), productData);
        
        cancelEdit();
        await loadProducts();
      } catch (err) {
        alert("Error updating product: " + err.message);
      }
    }

    function cancelEdit() {
      editingProductId = null;
      
      document.getElementById("productName").value = "";
      document.getElementById("productDescription").value = "";
      document.getElementById("productPrice").value = "";
      document.getElementById("productStockQty").value = "";
      document.getElementById("productMerchantId").value = "";
      document.getElementById("productCategory").value = "Electronics";
      document.getElementById("productStatus").value = "active";
      
      document.getElementById("createProductBtn").style.display = "inline-block";
      document.getElementById("updateProductBtn").style.display = "none";
      document.getElementById("cancelEditBtn").style.display = "none";
    }

    async function toggleProductStatus(productId) {
      try {
        const productDoc = await getDoc(doc(db, "product_list", productId));
        
        if (!productDoc.exists()) {
          alert("Product not found!");
          return;
        }
        
        const product = productDoc.data();
        const newStatus = product.status === 'active' ? 'inactive' : 'active';
        
        await updateDoc(doc(db, "product_list", productId), {
          status: newStatus,
          updatedAt: new Date()
        });
        
        await loadProducts();
      } catch (err) {
        alert("Error toggling product status: " + err.message);
      }
    }
  </script>
</body>
</html>