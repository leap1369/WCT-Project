<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard - Ecommerce Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Styling ===== */
    :root { color-scheme: light; }
    body { font-family: system-ui, Arial, sans-serif; background:#f7f8fb; margin:0; }
    header { max-width: 1200px; margin: 0 auto; padding: 16px; display:flex; align-items:center; justify-content:space-between; background:#fff; border-bottom:1px solid #eee; }
    .pill { background:#eef3ff; border:1px solid #d8e3fe; padding:6px 10px; border-radius:999px; font-size:12px; color:#2c7ef8; }
    nav ul { display:flex; gap:10px; padding:0; list-style:none; margin:0 0 0 12px; }
    nav a { padding:8px 12px; border-radius:8px; text-decoration:none; color:#333; background:#fff; border:1px solid #eee; }
    main { max-width: 1200px; margin: 0 auto; padding: 16px 0 40px; }
    h2 { margin:18px 0 10px; }
    .grid4 { display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; margin:12px 0; }
    .big { font-size:26px; font-weight:700; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:13px; vertical-align:top; }
    thead th { background:#f8f9fc; font-weight:600; }
    .actions button { margin-right:6px; padding:6px 10px; font-size:12px; border:1px solid #ddd; border-radius:6px; cursor:pointer; background:#fff; }
    .btn { display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .btn-primary { background:#2c7ef8; color:#fff; border-color:#2c7ef8; }
    .filters { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
    .search { flex:1; min-width:220px; padding:8px; border:1px solid #ddd; border-radius:8px; }
    .flex { display:flex; align-items:center; gap:8px; }
    .muted { color:#777; font-size:12px; }
    .form-row { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .form-row input, .form-row select, .form-row textarea { padding:8px; border:1px solid #ddd; border-radius:8px; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; }
    .chip.true { background:#e9f9ed; color:#2f9e44; border-color:#b8e4c2; }
    .chip.false { background:#fff4f4; color:#c53b3b; border-color:#f0caca; }
    .id-note { font-size:12px; color:#555; margin-top:6px; }
    .link { color:#2c7ef8; text-decoration:none; }
    .link:hover { text-decoration:underline; }
        /* ===== Sticky Header ===== */
    header {
      position: fixed;  /* Change from default to fixed */
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;    /* Ensure it stays above other content */
      width: 100%;      /* Full width */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Optional shadow */
    }
    
    /* Add padding to main to account for fixed header */
    main {
      margin-top: 80px; /* Adjust based on your header height */
    }
    
    /* Optional: Smooth scrolling for anchor links */
    html {
      scroll-behavior: smooth;
    }
    
    /* Ensure nav links work with fixed header */
    section {
      scroll-margin-top: 80px; /* Same as main margin-top */
    }
  </style>
</head>
<body>
  <header>
    <div class="flex">
      <span class="pill">Admin Panel</span>
      <nav>
        <ul>
          <li><a href="#dashboard">Dashboard</a></li>
          <li><a href="#users">Users</a></li>
          <li><a href="#applications">Merchant Applications</a></li>
          <li><a href="#merchants">Active Merchants</a></li>
          <li><a href="#orders">Orders</a></li>
          <li><a href="#products">Products</a></li>
        </ul>
      </nav>
    </div>
    <div class="flex">
      <div id="adminName" class="muted">Admin</div>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </header>

  <main>
    <!-- ===== Overview ===== -->
    <section id="dashboard" class="card">
      <h2>Admin Dashboard</h2>
      <div class="flex"><button id="refreshOverview" class="btn">Refresh Data</button></div>
      <div class="grid4" style="margin-top:12px;">
        <div class="card"><div class="big" id="totalUsers">0</div><div class="muted">Total Users</div></div>
        <div class="card"><div class="big" id="activeMerchants">0</div><div class="muted">Active Merchants</div></div>
        <div class="card"><div class="big" id="totalOrders">0</div><div class="muted">Total Orders</div></div>
        <div class="card"><div class="big" id="platformRevenue">$0</div><div class="muted">Platform Revenue</div></div>
      </div>
    </section>

    <!-- ===== Users ===== -->
    <section id="users" class="card">
      <h2>User Management</h2>
      <div class="filters">
        <select id="userRoleFilter">
          <option value="">All Roles</option>
          <option value="user">user</option>
          <option value="merchant">merchant</option>
          <option value="ADMINISTRATOR">ADMINISTRATOR</option>
        </select>
        <input id="userSearch" class="search" placeholder="Search users (ID, name, email, role)..." />
        <button id="refreshUsers" class="btn">Refresh</button>
      </div>

      <div class="form-row">
        <input id="firstName" placeholder="First name" />
        <input id="lastName" placeholder="Last name" />
        <input id="displayName" placeholder="Display name" />
        <input id="email" type="email" placeholder="Email" />
        <input id="profilePicture" placeholder="Profile picture URL (optional)" />
        <select id="role">
          <option value="user">user</option>
          <option value="merchant">merchant</option>
          <option value="ADMINISTRATOR">ADMINISTRATOR</option>
        </select>
        <button id="createUserBtn" class="btn-primary">Create User Doc</button>
      </div>

      <table id="usersTable">
        <thead>
          <tr>
            <th>ID</th><th>User</th><th>Email</th><th>Role</th><th>Email Verified</th><th>Last Login</th><th>Created At</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="id-note">Tip: ID search matches the **document ID** shown in the leftmost column.</div>
    </section>

    <!-- ===== Merchant Applications ===== -->
    <section id="applications" class="card">
      <h2>Merchant Applications</h2>
      <div class="filters">
        <select id="appStatusFilter">
          <option value="">All Status</option>
          <option value="Pending Review">Pending Review</option>
          <option value="Under Review">Under Review</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
        </select>
        <input id="appSearch" class="search" placeholder="Search applications (ID, business, type, city, email)..." />
        <button id="refreshApps" class="btn">Refresh</button>
      </div>

      <!-- Optional admin-side quick create -->
      <div class="form-row">
        <input id="appBusinessName" placeholder="Business Name" />
        <select id="appBusinessType">
          <option value="Retail">Retail</option><option value="Wholesale">Wholesale</option>
          <option value="Manufacturing">Manufacturing</option><option value="Service">Service</option>
          <option value="Technology">Technology</option><option value="Agriculture">Agriculture</option>
          <option value="Construction">Construction</option><option value="Hospitality">Hospitality</option>
          <option value="Transportation">Transportation</option><option value="Finance">Finance</option>
          <option value="Healthcare">Healthcare</option><option value="Education">Education</option>
          <option value="Real Estate">Real Estate</option><option value="Entertainment">Entertainment</option>
          <option value="Nonprofit">Nonprofit</option>
        </select>
        <input id="appAddress" placeholder="Address" />
        <select id="appCity">
          <option value="Phnom Penh">Phnom Penh</option><option value="Siem Reap">Siem Reap</option>
        </select>
        <input id="appZipcode" placeholder="Zipcode" />
        <input id="appDescription" placeholder="Business Description" />
        <input id="appApplicantEmail" placeholder="Applicant Email (optional)" />
        <button id="createAppBtn" class="btn-primary">Save Application</button>
      </div>

      <table id="merchantAppsTable">
        <thead>
          <tr>
            <th>Application ID</th><th>Business Name</th><th>Type</th><th>City</th>
            <th>Applicant Email</th><th>Business Doc</th><th>Identity Doc</th>
            <th>Applied Date</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="id-note">Note: Application IDs match the **user's doc ID** (set by the registration form).</div>
    </section>

    <!-- ===== Verified (Active) Merchants ===== -->
    <section id="merchants" class="card">
      <h2>Active Merchants</h2>
      <div class="filters">
        <input id="merchantSearch" class="search" placeholder="Search merchants (ID, store, owner, city, email)..." />
        <button id="refreshMerchants" class="btn">Refresh</button>
      </div>
      <table id="merchantsTable">
        <thead>
          <tr><th>ID</th><th>Store</th><th>Owner</th><th>City</th><th>Email</th><th>Docs</th><th>Joined</th><th>Status</th><th>Verification</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ===== Orders ===== -->
    <section id="orders" class="card">
      <h2>Order Management</h2>
      <div class="muted">Coming soonâ€¦</div>
    </section>

    <!-- ===== Product Management ===== -->
    <section id="products" class="card">
      <h2>Product Management</h2>
      <div class="filters">
        <select id="productCategoryFilter">
          <option value="">All Categories</option>
          <option value="Electronics">Electronics</option>
          <option value="Clothing">Clothing</option>
          <option value="Home & Garden">Home & Garden</option>
          <option value="Sports">Sports</option>
          <option value="Books">Books</option>
          <option value="Other">Other</option>
        </select>
        <select id="productStatusFilter">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="out_of_stock">Out of Stock</option>
        </select>
        <input id="productSearch" class="search" placeholder="Search products (name, description, merchant ID)..." />
        <button id="refreshProducts" class="btn">Refresh</button>
      </div>

      <!-- Create/Edit Product Form -->
      <div class="form-row">
        <input id="productName" placeholder="Product Name" />
        <input id="productDescription" placeholder="Description" />
        <input id="productPrice" type="number" placeholder="Price" step="0.01" min="0" />
        <input id="productStockQty" type="number" placeholder="Stock Quantity" min="0" />
        <select id="productCategory">
          <option value="Electronics">Electronics</option>
          <option value="Clothing">Clothing</option>
          <option value="Home & Garden">Home & Garden</option>
          <option value="Sports">Sports</option>
          <option value="Books">Books</option>
          <option value="Other">Other</option>
        </select>
        <select id="productStatus">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="out_of_stock">Out of Stock</option>
        </select>
        <input id="productMerchantId" placeholder="Merchant ID (optional)" />
        <button id="createProductBtn" class="btn-primary">Create Product</button>
        <button id="updateProductBtn" class="btn" style="display:none;">Update Product</button>
        <button id="cancelEditBtn" class="btn" style="display:none;">Cancel</button>
      </div>

      <table id="productsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Category</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Status</th>
            <th>Merchant ID</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>
   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs,
      updateDoc, deleteDoc, query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBKswcE3xGh4feqGZytevh6N-IyrJoJ_7g",
      authDomain: "jeahluy.firebaseapp.com",
      projectId: "jeahluy",
      storageBucket: "jeahluy.firebasestorage.app",
      messagingSenderId: "308746007810",
      appId: "1:308746007810:web:c17396303b14d61c3b3e1b",
      measurementId: "G-3RLD0EB1FT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_UID = "zYSujcmGisVdCNPYCfwb7tbpG3D2";
    const ROLES = { USER: "user", MERCHANT: "merchant", ADMIN: "ADMINISTRATOR" };
    
    // Utility Functions
    const normalizeRole = (val) => { 
      if (!val) return ""; 
      const s = String(val).trim().toLowerCase(); 
      if (s === "user") return ROLES.USER; 
      if (s === "merchant") return ROLES.MERCHANT; 
      if (s.startsWith("admin")) return ROLES.ADMIN; 
      return ROLES.USER; 
    };
    
    const fmtDate = (v, withTime = false) => { 
      if (!v) return "-"; 
      const d = v?.toDate ? v.toDate() : (typeof v === "string" ? new Date(v) : new Date(v)); 
      return withTime ? d.toLocaleString() : d.toLocaleDateString(); 
    };
    
    const debounce = (fn, ms = 250) => { 
      let t; 
      return (...args) => { 
        clearTimeout(t); 
        t = setTimeout(() => fn(...args), ms); 
      }; 
    };

    let bootstrapped = false;

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.uid !== ADMIN_UID) {
        if (!/admin-login\.html$/i.test(location.pathname)) location.replace("admin-login.html");
        return;
      }
      if (bootstrapped) return;
      bootstrapped = true;

      document.getElementById("adminName").textContent = `Admin (${user.email || ADMIN_UID})`;

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        try { await signOut(auth); } catch(_) {}
        location.replace("admin-login.html");
      });

      // Overview
      document.getElementById("refreshOverview").addEventListener("click", initOverview);

      // Users
      const onUserSearch = debounce(loadUsers, 200);
      document.getElementById("userRoleFilter").addEventListener("change", loadUsers);
      document.getElementById("userSearch").addEventListener("input", onUserSearch);
      document.getElementById("refreshUsers").addEventListener("click", loadUsers);
      document.getElementById("createUserBtn").addEventListener("click", createUserDoc);

      // Applications
      const onAppSearch = debounce(loadMerchantApplications, 200);
      document.getElementById("appStatusFilter").addEventListener("change", loadMerchantApplications);
      document.getElementById("appSearch").addEventListener("input", onAppSearch);
      document.getElementById("refreshApps").addEventListener("click", loadMerchantApplications);
      document.getElementById("createAppBtn").addEventListener("click", createApplicationFromAdmin);

      // Verified merchants
      const onMerchantSearch = debounce(loadVerifiedMerchants, 200);
      document.getElementById("merchantSearch").addEventListener("input", onMerchantSearch);
      document.getElementById("refreshMerchants").addEventListener("click", loadVerifiedMerchants);

      // Product Management
      const onProductSearch = debounce(loadProducts, 200);
      document.getElementById("productSearch").addEventListener("input", onProductSearch);
      document.getElementById("refreshProducts").addEventListener("click", loadProducts);
      document.getElementById("productCategoryFilter").addEventListener("change", loadProducts);
      document.getElementById("productStatusFilter").addEventListener("change", loadProducts);
      document.getElementById("createProductBtn").addEventListener("click", createProduct);
      document.getElementById("updateProductBtn").addEventListener("click", updateProduct);
      document.getElementById("cancelEditBtn").addEventListener("click", cancelEdit);

      // Initial load
      initOverview();
      loadUsers();
      loadMerchantApplications();
      loadVerifiedMerchants();
      loadProducts();
    });

    /* ===== Overview ===== */
    async function initOverview() {
      const users = await getDocs(collection(db, "users"));
      const verified = await getDocs(collection(db, "verifiedMerchants"));
      document.getElementById("totalUsers").textContent = users.size;
      document.getElementById("activeMerchants").textContent = verified.size;
      document.getElementById("totalOrders").textContent = 0;
      document.getElementById("platformRevenue").textContent = "$0.00";
    }

    /* ===== Users ===== */
    async function createUserDoc() {
      const firstName = document.getElementById("firstName").value.trim();
      const lastName = document.getElementById("lastName").value.trim();
      const displayName = document.getElementById("displayName").value.trim();
      const email = document.getElementById("email").value.trim();
      const profilePicture = document.getElementById("profilePicture").value.trim();
      const role = normalizeRole(document.getElementById("role").value);
      if (!email || (!firstName && !displayName)) return alert("Provide Email and First/Display name.");
      await addDoc(collection(db, "users"), {
        createdAt: new Date(),
        displayName: displayName || `${firstName || ""} ${lastName || ""}`.trim(),
        email, emailVerified: false,
        firstName: firstName || "", lastName: lastName || "",
        lastLogin: null, profilePicture: profilePicture || "", role
      });
      ["firstName","lastName","displayName","email","profilePicture"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("role").value = ROLES.USER;
      await loadUsers(); await initOverview();
    }

    async function loadUsers() {
      const tbody = document.querySelector("#usersTable tbody"); tbody.innerHTML = "";
      const roleFilter = normalizeRole(document.getElementById("userRoleFilter").value || "");
      const qText = (document.getElementById("userSearch").value || "").toLowerCase();
      const base = collection(db, "users");

      let q;
      if (roleFilter) { q = query(base, where("role", "==", roleFilter)); }
      else { try { q = query(base, orderBy("createdAt","desc")); } catch { q = base; } }

      let snap; try { snap = await getDocs(q); }
      catch { snap = roleFilter ? await getDocs(query(base, where("role","==", roleFilter))) : await getDocs(base); }

      const matches = snap.docs.map(d => ({ id: d.id, data: d.data() }))
        .filter(({id, data:u}) => {
          if (!qText) return true;
          const hay = [id, u.displayName, u.firstName, u.lastName, u.email, u.role]
            .map(x => String(x || "").toLowerCase()).join(" ");
          return hay.includes(qText);
        })
        .sort((a,b) => {
          const aj = a.data.createdAt ? (a.data.createdAt?.toDate ? a.data.createdAt.toDate() : new Date(a.data.createdAt)) : 0;
          const bj = b.data.createdAt ? (b.data.createdAt?.toDate ? b.data.createdAt.toDate() : new Date(b.data.createdAt)) : 0;
          return bj - aj;
        });

      if (!matches.length) { const tr = document.createElement("tr"); tr.innerHTML = `<td colspan="8" class="muted">No users found.</td>`; tbody.appendChild(tr); return; }

      matches.forEach(({ id, data: d }) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td><div>${d.displayName || `${d.firstName || "-"} ${d.lastName || ""}`.trim()}</div></td>
          <td>${d.email || "-"}</td>
          <td>${d.role || "-"}</td>
          <td><span class="chip ${d.emailVerified ? "true" : "false"}">${d.emailVerified ? "true" : "false"}</span></td>
          <td>${fmtDate(d.lastLogin, true)}</td>
          <td>${fmtDate(d.createdAt, true)}</td>
          <td class="actions">
            <button data-action="set-role" data-id="${id}" data-role="user">Role: user</button>
            <button data-action="set-role" data-id="${id}" data-role="merchant">Role: merchant</button>
            <button data-action="set-role" data-id="${id}" data-role="ADMINISTRATOR">Role: ADMIN</button>
            <button data-action="verify-email" data-id="${id}">Verify email</button>
            <button data-action="delete" data-id="${id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.onclick = async (e) => {
        const btn = e.target.closest("button[data-action]"); if (!btn) return;
        const id = btn.dataset.id; const action = btn.dataset.action;
        try {
          if (action === "set-role") { await updateDoc(doc(db, "users", id), { role: normalizeRole(btn.dataset.role) }); }
          else if (action === "verify-email") { await updateDoc(doc(db, "users", id), { emailVerified: true }); }
          else if (action === "delete") { await deleteDoc(doc(db, "users", id)); }
          await loadUsers(); await initOverview();
        } catch (err) { alert(err?.message || "Action failed"); }
      };
    }

    /* ===== Merchant Applications ===== */
    async function createApplicationFromAdmin() {
      const businessName = document.getElementById("appBusinessName").value.trim();
      const businessType = document.getElementById("appBusinessType").value;
      const address = document.getElementById("appAddress").value.trim();
      const city = document.getElementById("appCity").value;
      const zipcode = document.getElementById("appZipcode").value.trim();
      const description = document.getElementById("appDescription").value.trim();
      const applicantEmail = (document.getElementById("appApplicantEmail").value || "").trim();
      if (!businessName || !businessType || !city) return alert("Business Name, Type, City required.");

      let applicantUserId = null;
      if (applicantEmail) {
        const q = query(collection(db, "users"), where("email","==", applicantEmail));
        const s = await getDocs(q);
        if (!s.empty) applicantUserId = s.docs[0].id;
      }

      if (applicantUserId) {
        await setDoc(doc(db, "merchantApplications", applicantUserId), {
          applicantUserId, applicantEmail,
          businessName, businessType, address, city, zipcode, description,
          status: "Pending Review", createdAt: new Date()
        }, { merge:true });
      } else {
        await addDoc(collection(db, "merchantApplications"), {
          applicantUserId: null, applicantEmail,
          businessName, businessType, address, city, zipcode, description,
          status: "Pending Review", createdAt: new Date()
        });
      }

      ["appBusinessName","appAddress","appZipcode","appDescription","appApplicantEmail"].forEach(id => document.getElementById(id).value = "");
      await loadMerchantApplications();
    }

    async function loadMerchantApplications() {
      const status = document.getElementById("appStatusFilter").value;
      const term = (document.getElementById("appSearch").value || "").toLowerCase();
      const base = collection(db, "merchantApplications");

      let q = status ? query(base, where("status","==",status)) : base;
      try { q = query(q, orderBy("createdAt","desc"), limit(200)); } catch(_) {}

      let snap; try { snap = await getDocs(q); }
      catch { snap = status ? await getDocs(query(base, where("status","==",status))) : await getDocs(base); }

      const tbody = document.querySelector("#merchantAppsTable tbody");
      tbody.innerHTML = "";

      const matches = snap.docs.map(d => ({ id: d.id, data: d.data() }))
        .filter(({id, data:a}) => {
          if (!term) return true;
          const hay = [id, a.businessName, a.businessType, a.city, a.applicantEmail]
            .map(x => String(x || "").toLowerCase()).join(" ");
          return hay.includes(term);
        });

      if (!matches.length) { const tr = document.createElement("tr"); tr.innerHTML = `<td colspan="10" class="muted">No applications.</td>`; tbody.appendChild(tr); return; }

      matches.forEach(({ id, data: d }) => {
        const businessLink = d.businessDocUrl
          ? `<a class="link" href="${d.businessDocUrl}" target="_blank" rel="noopener">Open</a>` : "-";
        const identityLink = d.identityDocUrl
          ? `<a class="link" href="${d.identityDocUrl}" target="_blank" rel="noopener">Open</a>` : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td>${d.businessName || "-"}</td>
          <td>${d.businessType || "-"}</td>
          <td>${d.city || "-"}</td>
          <td>${d.applicantEmail || "-"}</td>
          <td>${businessLink}</td>
          <td>${identityLink}</td>
          <td>${fmtDate(d.createdAt, true)}</td>
          <td>${d.status}</td>
          <td class="actions">
            <button data-action="approve" data-id="${id}">Approve</button>
            <button data-action="reject" data-id="${id}">Reject</button>
            <button data-action="delete" data-id="${id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.onclick = async (e) => {
        const btn = e.target.closest("button[data-action]"); if (!btn) return;
        const id = btn.dataset.id; const action = btn.dataset.action;
        try {
          const appRef = doc(db, "merchantApplications", id);
          if (action === "approve") {
            const app = (await getDoc(appRef)).data();
            await setDoc(doc(db, "verifiedMerchants", id), {
              store: app.businessName,
              owner: app.owner || app.businessName,
              city: app.city,
              email: app.applicantEmail || "",
              businessDocUrl: app.businessDocUrl || null,
              identityDocUrl: app.identityDocUrl || null,
              status: "Active",
              verification: "Verified",
              joined: new Date(),
              applicationId: id,
              businessType: app.businessType,
              address: app.address || "",
              zipcode: app.zipcode || "",
              description: app.description || ""
            }, { merge:true });
            await deleteDoc(appRef);
          } else if (action === "reject") {
            await updateDoc(appRef, { status: "Rejected", rejectedAt: new Date() });
          } else if (action === "delete") {
            await deleteDoc(appRef);
          }
          await loadMerchantApplications(); await loadVerifiedMerchants(); await initOverview();
        } catch (err) { alert(err?.message || "Action failed"); }
      };
    }

    /* ===== Active Merchants ===== */
    async function loadVerifiedMerchants() {
      const tbody = document.querySelector("#merchantsTable tbody");
      const term = (document.getElementById("merchantSearch").value || "").toLowerCase();
      tbody.innerHTML = "";

      let q; try { q = query(collection(db, "verifiedMerchants"), orderBy("joined","desc")); }
      catch { q = collection(db, "verifiedMerchants"); }

      let snap; try { snap = await getDocs(q); }
      catch { snap = await getDocs(collection(db, "verifiedMerchants")); }

      const matches = snap.docs.map(d => ({ id: d.id, data: d.data() }))
        .filter(({id, data:m}) => {
          if (!term) return true;
          const hay = [id, m.store, m.owner, m.city, m.email]
            .map(x => String(x || "").toLowerCase()).join(" ");
          return hay.includes(term);
        });

      if (!matches.length) { const tr = document.createElement("tr"); tr.innerHTML = `<td colspan="10" class="muted">No verified merchants.</td>`; tbody.appendChild(tr); return; }

      matches.forEach(({ id, data: d }) => {
        const docsHTML = [
          d.businessDocUrl ? `<a class="link" href="${d.businessDocUrl}" target="_blank" rel="noopener">BizDoc</a>` : null,
          d.identityDocUrl ? `<a class="link" href="${d.identityDocUrl}" target="_blank" rel="noopener">IDDoc</a>` : null
        ].filter(Boolean).join(" | ") || "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td>${d.store || "-"}</td>
          <td>${d.owner || "-"}</td>
          <td>${d.city || "-"}</td>
          <td>${d.email || "-"}</td>
          <td>${docsHTML}</td>
          <td>${fmtDate(d.joined)}</td>
          <td>${d.status || "Active"}</td>
          <td>${d.verification || "Verified"}</td>
          <td class="actions">
            <button data-action="activate" data-id="${id}">Activate</button>
            <button data-action="suspend" data-id="${id}">Suspend</button>
            <button data-action="delete" data-id="${id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.onclick = async (e) => {
        const btn = e.target.closest("button[data-action]"); if (!btn) return;
        const id = btn.dataset.id; const action = btn.dataset.action;
        try {
          const ref = doc(db, "verifiedMerchants", id);
          if (action === "activate") { await updateDoc(ref, { status: "Active" }); }
          else if (action === "suspend") { await updateDoc(ref, { status: "Suspended" }); }
          else if (action === "delete") { await deleteDoc(ref); }
          await loadVerifiedMerchants(); await initOverview();
        } catch (err) { alert(err?.message || "Action failed"); }
      };
    }

    /* ===== Product Management ===== */
    let editingProductId = null;

    async function loadProducts() {
      const tbody = document.querySelector("#productsTable tbody");
      if (!tbody) return;
      
      tbody.innerHTML = "";
      
      const category = document.getElementById("productCategoryFilter")?.value || "";
      const status = document.getElementById("productStatusFilter")?.value || "";
      const searchTerm = (document.getElementById("productSearch")?.value || "").toLowerCase();
      
      try {
        let q = collection(db, "product_list");
        
        if (category) {
          q = query(q, where("category", "==", category));
        }
        if (status) {
          q = query(q, where("status", "==", status));
        }
        
        try {
          q = query(q, orderBy("createdAt", "desc"));
        } catch (err) {
          console.log("No index for createdAt ordering");
        }
        
        const snap = await getDocs(q);
        
        if (snap.empty) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="10" class="muted">No products found.</td>`;
          tbody.appendChild(tr);
          return;
        }
        
        const products = snap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        })).filter(product => {
          if (!searchTerm) return true;
          
          const searchable = [
            product.id,
            product.name || "",
            product.description || "",
            product.merchantId || "",
            product.category || ""
          ].map(x => String(x).toLowerCase()).join(" ");
          
          return searchable.includes(searchTerm);
        });
        
        products.forEach(product => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${product.id}</td>
            <td>${product.name || "-"}</td>
            <td>${product.category || "-"}</td>
            <td>$${parseFloat(product.price || 0).toFixed(2)}</td>
            <td>${product.stockQty || 0}</td>
            <td><span class="chip ${product.status === 'active' ? 'true' : 'false'}">${product.status || "-"}</span></td>
            <td><span class="muted">${(product.merchantId || "").substring(0, 8)}...</span></td>
            <td>${fmtDate(product.createdAt, true)}</td>
            <td>${fmtDate(product.updatedAt, true)}</td>
            <td class="actions">
              <button data-action="edit" data-id="${product.id}">Edit</button>
              <button data-action="toggle-status" data-id="${product.id}">${product.status === 'active' ? 'Deactivate' : 'Activate'}</button>
              <button data-action="delete" data-id="${product.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        tbody.onclick = async (e) => {
          const btn = e.target.closest("button[data-action]");
          if (!btn) return;
          
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          
          try {
            if (action === "edit") {
              await editProduct(id);
            } else if (action === "toggle-status") {
              await toggleProductStatus(id);
            } else if (action === "delete") {
              if (confirm("Are you sure you want to delete this product?")) {
                await deleteDoc(doc(db, "product_list", id));
                await loadProducts();
              }
            }
          } catch (err) {
            alert(err?.message || "Action failed");
          }
        };
        
      } catch (err) {
        console.error("Error loading products:", err);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="10" class="muted">Error loading products: ${err.message}</td>`;
        tbody.appendChild(tr);
      }
    }

    async function createProduct() {
      const name = document.getElementById("productName").value.trim();
      const description = document.getElementById("productDescription").value.trim();
      const price = parseFloat(document.getElementById("productPrice").value);
      const stockQty = parseInt(document.getElementById("productStockQty").value);
      const category = document.getElementById("productCategory").value;
      const status = document.getElementById("productStatus").value;
      const merchantId = document.getElementById("productMerchantId").value.trim();
      
      if (!name || !category || price < 0 || stockQty < 0) {
        return alert("Please fill in all required fields with valid values.");
      }
      
      if (merchantId) {
        try {
          const merchantDoc = await getDoc(doc(db, "verifiedMerchants", merchantId));
          if (!merchantDoc.exists()) {
            if (!confirm("Merchant ID not found in verified merchants. Continue anyway?")) {
              return;
            }
          }
        } catch (err) {
          console.log("Merchant verification skipped");
        }
      }
      
      const productData = {
        name,
        description,
        price: parseFloat(price.toFixed(2)),
        stockQty,
        category,
        status,
        merchantId: merchantId || null,
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      try {
        await addDoc(collection(db, "product_list"), productData);
        
        document.getElementById("productName").value = "";
        document.getElementById("productDescription").value = "";
        document.getElementById("productPrice").value = "";
        document.getElementById("productStockQty").value = "";
        document.getElementById("productMerchantId").value = "";
        
        await loadProducts();
      } catch (err) {
        alert("Error creating product: " + err.message);
      }
    }

    async function editProduct(productId) {
      try {
        const productDoc = await getDoc(doc(db, "product_list", productId));
        
        if (!productDoc.exists()) {
          alert("Product not found!");
          return;
        }
        
        const product = productDoc.data();
        
        document.getElementById("productName").value = product.name || "";
        document.getElementById("productDescription").value = product.description || "";
        document.getElementById("productPrice").value = product.price || "";
        document.getElementById("productStockQty").value = product.stockQty || "";
        document.getElementById("productCategory").value = product.category || "Other";
        document.getElementById("productStatus").value = product.status || "active";
        document.getElementById("productMerchantId").value = product.merchantId || "";
        
        editingProductId = productId;
        document.getElementById("createProductBtn").style.display = "none";
        document.getElementById("updateProductBtn").style.display = "inline-block";
        document.getElementById("cancelEditBtn").style.display = "inline-block";
        
      } catch (err) {
        alert("Error loading product for editing: " + err.message);
      }
    }

    async function updateProduct() {
      if (!editingProductId) return;
      
      const name = document.getElementById("productName").value.trim();
      const description = document.getElementById("productDescription").value.trim();
      const price = parseFloat(document.getElementById("productPrice").value);
      const stockQty = parseInt(document.getElementById("productStockQty").value);
      const category = document.getElementById("productCategory").value;
      const status = document.getElementById("productStatus").value;
      const merchantId = document.getElementById("productMerchantId").value.trim();
      
      if (!name || !category || price < 0 || stockQty < 0) {
        return alert("Please fill in all required fields with valid values.");
      }
      
      const productData = {
        name,
        description,
        price: parseFloat(price.toFixed(2)),
        stockQty,
        category,
        status,
        merchantId: merchantId || null,
        updatedAt: new Date()
      };
      
      try {
        await updateDoc(doc(db, "product_list", editingProductId), productData);
        
        cancelEdit();
        await loadProducts();
      } catch (err) {
        alert("Error updating product: " + err.message);
      }
    }

    function cancelEdit() {
      editingProductId = null;
      
      document.getElementById("productName").value = "";
      document.getElementById("productDescription").value = "";
      document.getElementById("productPrice").value = "";
      document.getElementById("productStockQty").value = "";
      document.getElementById("productMerchantId").value = "";
      document.getElementById("productCategory").value = "Electronics";
      document.getElementById("productStatus").value = "active";
      
      document.getElementById("createProductBtn").style.display = "inline-block";
      document.getElementById("updateProductBtn").style.display = "none";
      document.getElementById("cancelEditBtn").style.display = "none";
    }

    async function toggleProductStatus(productId) {
      try {
        const productDoc = await getDoc(doc(db, "product_list", productId));
        
        if (!productDoc.exists()) {
          alert("Product not found!");
          return;
        }
        
        const product = productDoc.data();
        const newStatus = product.status === 'active' ? 'inactive' : 'active';
        
        await updateDoc(doc(db, "product_list", productId), {
          status: newStatus,
          updatedAt: new Date()
        });
        
        await loadProducts();
      } catch (err) {
        alert("Error toggling product status: " + err.message);
      }
    }
  </script>
</body>
</html>